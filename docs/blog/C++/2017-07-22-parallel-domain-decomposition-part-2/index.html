<!DOCTYPE HTML>
<html class="no-js" lang="en-US">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallel domain decomposition for particle methods: Part 2</title>
  <link rel="stylesheet" href="https://bbanerjee.github.io/ParSim/assets/css/screen.css">
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic%7cVolkhov:400,700' rel='stylesheet' type='text/css'>
  <script src="https://bbanerjee.github.io/ParSim/assets/js/modernizr.min.js"></script>
</head>


<body class="wrap">

  <script type="text/javascript"
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_HTMLorMML">
  </script>

  <header>
  <div class="grid">
    <div class="unit one-third center-on-mobiles">
      <h1>
        <a href="/">
          <span class="sr-only">ParSim</span>
          <img src="https://bbanerjee.github.io/ParSim/assets/img/ParresiaLogoSep2017_plain.png" 
               width="249" height="115" alt="ParSim">
        </a>
      </h1>
    </div>
    <nav class="main-nav unit two-thirds hide-on-mobiles">
      <ul>
  <li class="">
    <a href="https://bbanerjee.github.io/ParSim">Home</a>
  </li>
  <li class="current">
    <a href="https://bbanerjee.github.io/ParSim/docs/home">Vaango Docs</a>
  </li>
  <li>
    <a href="https://github.com/bbanerjee/ParSim">GitHub Source</a>
  </li>
</ul>

    </nav>
  </div>
</header>



    <section class="docs">
    <div class="grid">

      <div class="unit four-fifths">
        <article>
          <h1>Parallel domain decomposition for particle methods: Part 2</h1>
          <ul class="notice--content" id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a></li>
  <li><a href="#exchanging-particles-between-processes" id="markdown-toc-exchanging-particles-between-processes">Exchanging particles between processes</a></li>
  <li><a href="#mpi-implementation" id="markdown-toc-mpi-implementation">MPI implementation</a>    <ul>
      <li><a href="#patchneighborcomm-struct" id="markdown-toc-patchneighborcomm-struct">PatchNeighborComm struct</a></li>
      <li><a href="#patch-struct" id="markdown-toc-patch-struct">Patch struct</a></li>
      <li><a href="#the-particle-exchange-function" id="markdown-toc-the-particle-exchange-function">The particle exchange function</a></li>
    </ul>
  </li>
  <li><a href="#remarks" id="markdown-toc-remarks">Remarks</a></li>
</ul>

<h4 id="introduction">Introduction</h4>
<p>The <a href="https://bbanerjee.github.io/ParSim/mpi/c++/parallel-domain-decomposition-part-1/">previous article</a> in this series
discussed the scatter operation for moving particles to various processes.  In this second part
of the series we will discuss a commonly used method of communicating information between
processes.  Each process is logically mapped to a “patch”.</p>

<p>In the animation below, particles are generated in the red patch “P0” and then scattered
to the other eight patches.  During a particle-based simulation, some information has to
be transferred between adjacent processes.  The amount of information that has to be
communicated depends on a characteristic length scale that is determined by the particle
algorithm.  In the animation, this length is shown by the “ghost” regions outlined in
a darker shade with dashed borders.</p>

<div align="center" style="border:1px solid black">
<div>
  <input name="restartScatter" type="button" value="Scatter particles" onclick="particleScatterGhost.restartAnimation()" />
</div>
<div>
  <canvas id="particle-scatter-ghost" height="500" width="500"></canvas>
</div>
</div>
<p />

<h4 id="exchanging-particles-between-processes">Exchanging particles between processes</h4>
<p>After the particles have been scattered and ghost regions identified, the particles in
the ghost regions are exchanged as depicted in the animation below.  Notice that, in
addition to the exchange between the left-right and top-bottom patches, the information
at corners of patches also have to communicated to the three adjacent patches for a total
of 8 communication steps. For three-dimensional simulations, 26 such communication steps
are needed for each patch. Also notice that all we are doing is increasing the size of
each patch and including regions of overlap between patches.</p>

<div align="center" style="border:1px solid black">
<div>
  <input name="restartExchange" type="button" value="Exchange ghost particles" onclick="particleExchange.restartAnimation()" />
</div>
<div>
  <canvas id="particle-exchange-ghost" height="500" width="500"></canvas>
</div>
</div>
<p />

<h4 id="mpi-implementation">MPI implementation</h4>
<p>To keep things manageable, we create a <code>PatchNeighborComm</code> struct for communications
between neighbor patches. We also define a <code>Patch</code> struct that takes care of the details for each patch.</p>

<h5 id="patchneighborcomm-struct">PatchNeighborComm struct</h5>
<p>The neighbor communication methods are defined as:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span></span><span class="k">enum</span> <span class="k">class</span> <span class="nc">PatchBoundary</span> <span class="o">:</span> <span class="kt">char</span> <span class="p">{</span>
  <span class="n">xminus</span><span class="p">,</span> <span class="n">xplus</span><span class="p">,</span> <span class="n">yminus</span><span class="p">,</span> <span class="n">yplus</span><span class="p">,</span> <span class="n">zminus</span><span class="p">,</span> <span class="n">zplus</span><span class="p">,</span> <span class="n">inside</span>
<span class="p">};</span>
<span class="k">struct</span> <span class="n">PatchNeighborComm</span> <span class="p">{</span>
  <span class="n">PatchBoundary</span> <span class="n">d_boundary</span><span class="p">;</span>   <span class="c1">// Whether the patch has a neighbor</span>
  <span class="kt">int</span> <span class="n">d_rank</span><span class="p">;</span>                 <span class="c1">// Rank of the neighbor</span>
  <span class="kt">int</span> <span class="n">d_mpiTag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">request</span> <span class="n">d_sendRecvReq</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">ParticlePArray</span> <span class="n">d_sentParticles</span><span class="p">;</span> <span class="c1">// For sends to neighbor</span>
  <span class="n">ParticlePArray</span> <span class="n">d_recvParticles</span><span class="p">;</span> <span class="c1">// For receives from neighbor</span>
  <span class="kt">void</span> <span class="nf">setNeighbor</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">,</span> <span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span>
                   <span class="k">const</span> <span class="n">IntVec</span><span class="o">&amp;</span> <span class="n">neighborCoords</span><span class="p">,</span>
                   <span class="n">PatchBoundary</span> <span class="n">boundaryFlag</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">asyncSendRecv</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                     <span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span> <span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">box</span><span class="p">,</span> <span class="k">const</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">tolerance</span><span class="p">,</span>
                     <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">findParticlesInBox</span><span class="p">(</span><span class="k">const</span> <span class="n">Box</span><span class="o">&amp;</span> <span class="n">box</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">,</span>
                          <span class="k">const</span> <span class="kt">double</span><span class="o">&amp;</span> <span class="n">tolerance</span><span class="p">,</span>
                          <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">inside</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">waitToFinish</span><span class="p">(</span><span class="kt">int</span> <span class="n">myRank</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">combineReceivedParticles</span><span class="p">(</span><span class="kt">int</span> <span class="n">myRank</span><span class="p">,</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">received</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>An implementation of the functions in this struct is shown below:</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span></span><span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">setNeighbor</span><span class="p">(</span><span class="c1">//....) {</span>
  <span class="kt">int</span> <span class="n">neighborRank</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">MPI_Cart_rank</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">neighborRank</span><span class="p">);</span>
  <span class="n">d_rank</span> <span class="o">=</span> <span class="n">neighborRank</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">neighborRank</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_boundary</span> <span class="o">=</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">d_boundary</span> <span class="o">=</span> <span class="n">boundaryFlag</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="c1">// Find the particles in the ghost box</span>
  <span class="n">findParticlesInBox</span><span class="p">(</span><span class="n">box</span><span class="p">,</span> <span class="n">particles</span><span class="p">,</span> <span class="n">tolerance</span><span class="p">,</span> <span class="n">d_sentParticles</span><span class="p">);</span>
  <span class="c1">// Asynchronous send</span>
  <span class="n">d_sendRecvReq</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">boostWorld</span><span class="p">.</span><span class="n">isend</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">d_mpiTag</span><span class="p">,</span> <span class="n">d_sentParticles</span><span class="p">);</span>
  <span class="c1">// Immediate asynchronous receive</span>
  <span class="n">d_sendRecvReq</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">boostWorld</span><span class="p">.</span><span class="n">irecv</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">d_mpiTag</span><span class="p">,</span> <span class="n">d_recvParticles</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">findParticlesInBox</span><span class="p">(</span><span class="c1">//...) { // Straightforward }</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">waitToFinish</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="c1">// Wait from processes to receive ghost data</span>
  <span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">wait_all</span><span class="p">(</span><span class="n">d_sendRecvReq</span><span class="p">,</span> <span class="n">d_sendRecvReq</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">PatchNeighborComm</span><span class="o">::</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="c1">//...) {</span>
  <span class="n">received</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">received</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">d_recvParticles</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">d_recvParticles</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<h5 id="patch-struct">Patch struct</h5>
<p>The <code>Patch</code> struct takes care of all the communication needs of each patch.  The
definition I cobbled together is listed below.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span></span><span class="k">struct</span> <span class="n">Patch</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">d_rank</span><span class="p">;</span>
  <span class="kt">double</span> <span class="n">d_ghostWidth</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">;</span>
  <span class="n">IntVec</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="n">Vec</span> <span class="n">d_lower</span><span class="p">,</span> <span class="n">d_upper</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus</span><span class="p">,</span> <span class="n">d_yMinus</span><span class="p">,</span> <span class="n">d_zMinus</span><span class="p">,</span> <span class="n">d_xPlus</span><span class="p">,</span> <span class="n">d_yPlus</span><span class="p">,</span> <span class="n">d_zPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_yMinus</span><span class="p">,</span> <span class="n">d_xMinus_yPlus</span><span class="p">,</span> <span class="n">d_xPlus_yMinus</span><span class="p">,</span> <span class="n">d_xPlus_yPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_zMinus</span><span class="p">,</span> <span class="n">d_xMinus_zPlus</span><span class="p">,</span> <span class="n">d_xPlus_zMinus</span><span class="p">,</span> <span class="n">d_xPlus_zPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_yMinus_zMinus</span><span class="p">,</span> <span class="n">d_yMinus_zPlus</span><span class="p">,</span> <span class="n">d_yPlus_zMinus</span><span class="p">,</span> <span class="n">d_yPlus_zPlus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_yMinus_zMinus</span><span class="p">,</span> <span class="n">d_xMinus_yPlus_zMinus</span><span class="p">,</span> <span class="n">d_xPlus_yMinus_zMinus</span><span class="p">,</span> <span class="n">d_xPlus_yPlus_zMinus</span><span class="p">;</span>
  <span class="n">PatchNeighborComm</span> <span class="n">d_xMinus_yMinus_zPlus</span><span class="p">,</span> <span class="n">d_xMinus_yPlus_zPlus</span><span class="p">,</span> <span class="n">d_xPlus_yMinus_zPlus</span><span class="p">,</span> <span class="n">d_xPlus_yPlus_zPlus</span><span class="p">;</span>
  <span class="n">Patch</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">,</span>
        <span class="kt">int</span> <span class="n">rank</span><span class="p">,</span> <span class="k">const</span> <span class="n">IntVec</span><span class="o">&amp;</span> <span class="n">mpiCoords</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span><span class="o">&amp;</span> <span class="n">lower</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vec</span><span class="o">&amp;</span> <span class="n">upper</span><span class="p">,</span>
        <span class="kt">double</span> <span class="n">ghostWidth</span><span class="p">,</span> <span class="kt">double</span> <span class="n">tolerance</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setXMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span> <span class="c1">// A patch boundary is at the domain boundary</span>
  <span class="kt">void</span> <span class="nf">setXPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">setYMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="nf">setZPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostXMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostXPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostXMinusYMinus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostXMinusYMinusZminus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="c1">// .....</span>
  <span class="kt">void</span> <span class="nf">sendRecvGhostXPlusYPlusZPlus</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">mpi</span><span class="o">::</span><span class="n">communicator</span><span class="o">&amp;</span> <span class="n">boostWorld</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">particles</span><span class="p">);</span>
  <span class="kt">void</span> <span class="nf">waitToFinish</span><span class="p">();</span>
  <span class="kt">void</span> <span class="nf">combineReceivedParticles</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">received</span><span class="p">);</span>
<span class="p">};</span></code></pre></figure>

<p>The implementation of the <code>Patch</code> struct that I came up with is summarized below.
The design can definitely be improved; but recall that our goal is to do a quick
parallelization of an existing serial code.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span></span><span class="n">Patch</span><span class="o">::</span><span class="n">Patch</span><span class="p">(</span><span class="c1">//...) {</span>
 <span class="n">d_rank</span> <span class="o">=</span> <span class="n">rank</span><span class="p">;</span>
 <span class="c1">//.....</span>
 <span class="n">setXPlus</span><span class="p">(</span><span class="n">cartComm</span><span class="p">);</span>
 <span class="c1">//.....</span>
 <span class="n">setZPlus</span><span class="p">(</span><span class="n">cartComm</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">setXMinus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">IntVec</span> <span class="n">neighborCoords</span> <span class="o">=</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="o">--</span><span class="n">neighborCoords</span><span class="p">.</span><span class="n">x</span><span class="p">();</span>
  <span class="n">d_xMinus</span><span class="p">.</span><span class="n">setNeighbor</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">d_rank</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">,</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">xminus</span><span class="p">);</span>
<span class="p">}</span>
<span class="c1">//......</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">setZPlus</span><span class="p">(</span><span class="n">MPI_Comm</span><span class="o">&amp;</span> <span class="n">cartComm</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">IntVec</span> <span class="n">neighborCoords</span> <span class="o">=</span> <span class="n">d_patchMPICoords</span><span class="p">;</span>
  <span class="o">++</span><span class="n">neighborCoords</span><span class="p">.</span><span class="n">z</span><span class="p">();</span>
  <span class="n">d_zPlus</span><span class="p">.</span><span class="n">setNeighbor</span><span class="p">(</span><span class="n">cartComm</span><span class="p">,</span> <span class="n">d_rank</span><span class="p">,</span> <span class="n">neighborCoords</span><span class="p">,</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">zplus</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="c1">//....) {</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Vec</span> <span class="n">ghostLower</span> <span class="o">=</span> <span class="n">d_lower</span><span class="p">;</span>
    <span class="n">Vec</span> <span class="n">ghostUpper</span> <span class="o">=</span> <span class="n">d_upper</span><span class="p">;</span>
    <span class="n">ghostUpper</span><span class="p">.</span><span class="n">setX</span><span class="p">(</span><span class="n">d_lower</span><span class="p">.</span><span class="n">x</span><span class="p">()</span> <span class="o">+</span> <span class="n">d_ghostWidth</span><span class="p">);</span>
    <span class="n">Box</span> <span class="nf">ghostBox</span><span class="p">(</span><span class="n">ghostLower</span><span class="p">,</span> <span class="n">ghostUpper</span><span class="p">);</span>
    <span class="n">d_xMinus</span><span class="p">.</span><span class="n">asyncSendRecv</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">d_rank</span><span class="p">,</span> <span class="n">ghostBox</span><span class="p">,</span> <span class="n">d_tolerance</span><span class="p">,</span> <span class="n">particles</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1">//......</span>
<span class="c1">//......</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">sendRecvGhostXPlusYPlusZPlus</span><span class="p">(</span><span class="c1">//....) {</span>
<span class="c1">//......</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">waitToFinish</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xMinus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_xMinus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">d_xPlus</span><span class="p">.</span><span class="n">d_boundary</span> <span class="o">==</span> <span class="n">PatchBoundary</span><span class="o">::</span><span class="n">inside</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">d_xPlus</span><span class="p">.</span><span class="n">waitToFinish</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">//.....</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">Patch</span><span class="o">::</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">ParticlePArray</span><span class="o">&amp;</span> <span class="n">received</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">received</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">d_xMinus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">received</span><span class="p">);</span>
  <span class="n">d_xPlus</span><span class="p">.</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">d_rank</span><span class="p">,</span> <span class="n">iteration</span><span class="p">,</span> <span class="n">received</span><span class="p">);</span>
  <span class="c1">//.....</span>
<span class="p">}</span></code></pre></figure>

<p />

<h5 id="the-particle-exchange-function">The particle exchange function</h5>
<p>The particle exchange function the main simulation code can then be written as follows.
Note that this design follows the approach taken by Dr. B. Yan for his parallel DEM code
developed a UC Boulder.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span></span><span class="kt">void</span>
<span class="n">ParticleCode</span><span class="o">::</span><span class="n">exchangeGhostParticles</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostYMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostYPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostZMinus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostZPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="c1">//.....</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">sendRecvGhostXPlusYPlusZPlus</span><span class="p">(</span><span class="n">boostWorld</span><span class="p">,</span> <span class="n">particleVec</span><span class="p">);</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">waitToFinish</span><span class="p">();</span>
  <span class="n">d_patchP</span><span class="o">-&gt;</span><span class="n">combineReceivedParticles</span><span class="p">(</span><span class="n">recvParticleVec</span><span class="p">);</span>
  <span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
  <span class="n">mergeParticleVec</span> <span class="o">=</span> <span class="n">particleVec</span><span class="p">;</span>
  <span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">mergeParticleVec</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">recvParticleVec</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span>
                          <span class="n">recvParticleVec</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
<span class="p">}</span></code></pre></figure>

<p>Clearly, a lot of communication and book-keeping is needed if we follow this approach.  An
alternative approach that uses fewer communication steps is the procedure developed by
Steve Plimpton (“Fast parallel algorithms for short-range molecular dynamics”, Sandia Report
SAND91-1144.UC-405, 1993).</p>

<h4 id="remarks">Remarks</h4>
<p>In the next part of this series, we will discuss Plimpton’s approach for domain decomposition.</p>

<p>If you have questions/comments/corrections, please contact banerjee at parresianz dot com dot zen (without the dot zen).</p>

<p><a class="twitter-share-button" href="https://twitter.com/intent/tweet" data-via="parresianz"> Tweet</a>
<script src="//platform.linkedin.com/in.js" type="text/javascript">
  lang: en_US
</script>
<script type="IN/Share" data-counter="right"></script></p>

<script src="https://bbanerjee.github.io/ParSim/assets/js/d3.v4.min.js"></script>

<script src="https://bbanerjee.github.io/ParSim/assets/js/colorbrewer.min.js"></script>

<script src="https://bbanerjee.github.io/ParSim/assets/js/particleScatterGhost.js"></script>

<script src="https://bbanerjee.github.io/ParSim/assets/js/particleExchange.js"></script>


          





  
  

  
  

  
  

  
  

  
  


        </article>
      </div>

      <div class="unit one-fifth hide-on-mobiles">
  <aside>
    
    <h4>Getting Started</h4>
    <ul>

  
  
  <li class=""><a href="https://bbanerjee.github.io/ParSim/docs/home/">Download</a></li>

  
  
  <li class=""><a href="https://bbanerjee.github.io/ParSim/docs/build-instructions/">Building Vaango</a></li>

  
  
  <li class=""><a href="https://bbanerjee.github.io/ParSim/docs/build-check/">Checking the build</a></li>

</ul>

    
    <h4>Vaango tutorials</h4>
    <ul>

  
  
  <li class=""><a href="https://bbanerjee.github.io/ParSim/docs/vaango/tutorials/tabular-j2-lin-elas/">Tabular J2-plasticity with linear elasticity</a></li>

</ul>

    
    <h4>MPM material models</h4>
    <ul>

  
  
  <li class=""><a href="https://bbanerjee.github.io/ParSim/docs/vaango/mpm-materials/tabular-plasticity/">Tabular plasticity</a></li>

</ul>

    
  </aside>
</div>


      <div class="clear"></div>

    </div>
  </section>


  <footer>
  <div class="grid">
    <div class="unit one-third center">
      <p>&copy;&nbsp;2018 under the terms of the <a href="https://github.com/bbanerjee/ParSim/blob/master/LICENSE">MIT&nbsp;License</a>.</p>
    </div>
    <div class="unit one-third align-right center">
      <p>
        Built with
        <a href="https://jekyllrb.com">
          <img src="https://bbanerjee.github.io/ParSim/assets/img/logo-2x.png" width = "70" height="30" alt="Jekyll">
        </a>
      </p>
    </div>
    <div class="unit one-third align-right center">
      <p>
        Hosted by
        <a href="https://github.com">
          <img src="https://bbanerjee.github.io/ParSim/assets/img/footer-logo.png" width="100" height="30" alt="GitHub • Social coding">
        </a>
      </p>
    </div>
  </div>
</footer>

  <script>
  var anchorForId = function (id) {
    var anchor = document.createElement("a");
    anchor.className = "header-link";
    anchor.href      = "#" + id;
    anchor.innerHTML = "<span class=\"sr-only\">Permalink</span><i class=\"fa fa-link\"></i>";
    anchor.title = "Permalink";
    return anchor;
  };

  var linkifyAnchors = function (level, containingElement) {
    var headers = containingElement.getElementsByTagName("h" + level);
    for (var h = 0; h < headers.length; h++) {
      var header = headers[h];

      if (typeof header.id !== "undefined" && header.id !== "") {
        header.appendChild(anchorForId(header.id));
      }
    }
  };

  document.onreadystatechange = function () {
    if (this.readyState === "complete") {
      var contentBlock = document.getElementsByClassName("docs")[0] || document.getElementsByClassName("news")[0];
      if (!contentBlock) {
        return;
      }
      for (var level = 1; level <= 6; level++) {
        linkifyAnchors(level, contentBlock);
      }
    }
  };
</script>

  
</body>
</html>
