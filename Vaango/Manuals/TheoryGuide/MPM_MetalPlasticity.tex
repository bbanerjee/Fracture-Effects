\chapter{Isotropic metal plasticity}
\begin{NoteBox}
The deformation gradient ($\BF$) can be decomposed into a rotation tensor ($\BR$)
and a stretch tensor ($\BU$) with th epolar decomposition $\BF = \BR\cdot\BU$.
In the isotropic metal plasticity model implemented in \Vaango, $\BR$ is used 
to rotate the stress ($\Bsig$) and the rate of deformation ($\BdT$) 
into the unrotated configuration before the updated stress is computed:
\Beq
  \widehat{\Bsig} = \BR^T\cdot\Bsig\cdot\BR ~;~~
  \dot{\BVeps} = \BR^T\cdot\BdT\cdot\BR 
\Eeq
where $\dot{\BVeps}$ is a ``natural'' strain rate.
After the stress has been updated, it is rotated back using
\Beq
  \Bsig = \BR\cdot\widehat{\Bsig}\cdot\BR^T \,.
\Eeq
In the following discussion, all equations should be treated as referring
to the hatted quantities even though we drop the hats for convenience.
\end{NoteBox}

\section{The model}
The Cauchy stress ($\Bsig$) is decomposed into volumetric and deviatoric parts:
\Beq \label{eq:stress_decomp}
  \Bsig = p~\BI + \BsT \quad \text{where} \quad  
  p = \Third~\Tr(\Bsig) \quad \Tand \quad
  \BsT = \Dev(\Bsig) = \Bsig - \Third\Tr(\Bsig) \,.
\Eeq
In the above $p = \sigma_m$ is the mean stress and $\BsT$ is the deviatoric stress.
The isotropy of the material allows us to compute the mean stress using an
equation of state if desired. The deviatoric stress is computed using a rate-form
stress-strain relation.
We simplify the discussion by assuming that rate-form relations are used for
both the mean stress and the deviatoric stress.  The time derivative of 
\eqref{eq:stress_decomp} is
\Beq
  \dot{\Bsig} = \dot{p}~\BI + \dot{\BsT} \,.
\Eeq
These stress rates have to be computed when a strain rate $\dot{\BVeps}$ is given, which
we assume can be additively decomposed into elastic ($\dot{\BVeps}^e$) and 
plastic ($\dot{\BVeps}^p$) parts:
\Beq
  \dot{\BVeps} = \dot{\BVeps}^e + \dot{\BVeps}^p \,.
\Eeq
The isotropic metal plasticity model in \Vaango solves the coupled equations
\Beq
  \dot{p} = g_1(\dot{\BVeps}^e, \dot{\BVeps}^p) ~,~~ \dot{\Bs} = g_2(\dot{\BVeps}^e, \dot{\BVeps}^p) \,.
\Eeq

\subsection{Elastic relation}
The elastic constitutive relation is assumed to be of the form
\Beq
  \dot{\Bsig}^e = \Partial{\Bsig}{\BVeps^e} : \dot{\BVeps}^e
                = \SfC^e : \dot{\BVeps}^e
\Eeq
where
\Beq
  \SfC^e =  \left(\kappa - \tfrac{2}{3}\mu\right) \BI\otimes\BI + 2\mu\, \Tsym(\SfI)
\Eeq
where $\mu(p, T, \phi, D)$ is the shear modulus, $\kappa(p,T, \phi, D)$ is the tangent 
bulk modulus, $\BI$ is the second-order identity tensor and $\SfI$ is the fourth-order
identity tensor.  $T$ is the current temperature, $\phi$ is the current porosity and
$D$ is a scalar damage parameter.  

If we consider thermal expansion,
\Beq
  \dot{\Bsig}^e = \Partial{\Bsig}{\BVeps^e} : \left(\dot{\BVeps}^e - \alpha \dot{T}\BI\right)
                = \SfC^e : \dot{\BVeps}^e - \alpha \dot{T}\, \SfC^e:\BI
\Eeq
where $\alpha$ is the coefficient of thermal expansion.
Expanded out, 
\Beq \label{eq:sig_dot_e}
  \dot{\Bsig}^e = \left(\kappa - \tfrac{2}{3}\mu\right) \Tr(\dot{\BVeps}^e) \BI + 2\mu\dot{\BVeps}^e 
                - 3\kappa\alpha\dot{T}\BI 
\Eeq

\subsection{Yield condition}
The yield condition is of the form
\Beq
  f(\Bsig, \Bbeta, \Veps^\Teq_p, \dot{\Veps}^\Teq_p, \phi, D, T, \dots) =
  f(\Bxi, p_\beta, \Veps^\Teq_p, \dot{\Veps}^\Teq_p, \phi, D, T, \dots) = 0
\Eeq
where $\Bxi = \Dev(\Bsig - \Bbeta)$ and $p_\beta = \Tr(\Bsig - \Bbeta)/3$. 

The Kuhn-Tucker loading-unloading conditions are
\Beq
  \dot{\lambda} \ge 0 ~;~~  f \le 0 ~;~~ \dot{\lambda}~f = 0
\Eeq
and the consistency condition is $\dot{f} = 0$.

\subsection{Flow rule}
We assume that the plastic rate of deformation is given by the flow rule
\Beq
  \dot{\BVeps}^p = \dot{\lambda}~\BM \,.
\Eeq

\subsection{Isotropic and kinematic hardening/softening rules}
The equivalent plastic strain ($\Veps_p^\Teq$) evolves according to the relation
\Beq
  \dot{\Veps}^\Teq_p = \dot{\lambda}~h^{\Veps_p} \,.
\Eeq
The back stress ($\Bbeta$) evolves according to the relation
\Beq
  \dot{\Bbeta} = \dot{\lambda}~\Bh^{\beta} \,.
\Eeq
The porosity ($\phi$) is assumed to evolve according to the relation
\Beq
  \dot{\phi} = \dot{\lambda}~h^{\phi} ~.
\Eeq
The damage parameter ($D$) evolves as
\Beq
  \dot{D} = \dot{\lambda}~h^D \,.
\Eeq
The temperature ($T_p$) due to plastic dissipation evolves as
\Beq
  \dot{T}_p = \dot{\lambda}~h^T \,.
\Eeq

\subsection{Elastic loading/unloading}
During purely elastic loading and unloading
\Beq
  \dot{\lambda} = 0 ~,~~ \dot{\BVeps}^p = \Bzero ~,~~ \dot{\BVeps} = \dot{\BVeps}^e \,.
\Eeq
In that situation, the stress is updated using \eqref{eq:sig_dot_e} with the no material
disspiation contribution to $\dot{T}$.

However, during elastic-plastic deformation, $\dot{\lambda} > 0$, and we have
\Beq
  \Bal
  \dot{\Bsig} & = \Partial{\Bsig}{\BVeps^e} : \left(\dot{\BVeps}^e -\alpha\dot{T}\BI\right) + 
                  \Partial{\Bsig}{\Bbeta} : \dot{\Bbeta} + 
                  \Partial{\Bsig}{\Veps^\Teq_p}  \dot{\Veps}^\Teq_p + 
                  \Partial{\Bsig}{\phi}  \dot{\phi} + 
                  \Partial{\Bsig}{D}  \dot{D} + 
                  \Partial{\Bsig}{T_p}  \dot{T}_p \\
   & = \SfC^e : \left(\dot{\BVeps}^e -\alpha\dot{T}\BI\right) + 
       \dot{\lambda}\left[\Partial{\Bsig}{\Bbeta} : \Bh^\beta + 
       \Partial{\Bsig}{\Veps^\Teq_p}  h^{\Veps_p} + 
       \Partial{\Bsig}{\phi} h^\phi + 
       \Partial{\Bsig}{D} h^D + 
       \Partial{\Bsig}{T_p} h^T\right] \\
   & = \SfC^e : (\dot{\BVeps} - \alpha\dot{T}\BI) -
       \dot{\lambda}\left[\SfC^e : \BM - \Partial{\Bsig}{\Bbeta} : \Bh^\beta -   
       \Partial{\Bsig}{\Veps^\Teq_p}  h^{\Veps_p} -         
       \Partial{\Bsig}{\phi} h^\phi -       
       \Partial{\Bsig}{D} h^D -        
       \Partial{\Bsig}{T_p} h^T\right]
  \Eal
\Eeq
Define
\Beq \label{eq:P_tensor}
  \BP := \SfC^e : \BM - \Partial{\Bsig}{\Bbeta} : \Bh^\beta -   
         \Partial{\Bsig}{\Veps^\Teq_p}  h^{\Veps_p} -         
         \Partial{\Bsig}{\phi} h^\phi -       
         \Partial{\Bsig}{D} h^D -        
         \Partial{\Bsig}{T_p} h^T \,.
\Eeq
Then, 
\Beq \label{eq:sig_dot_elas}
  \dot{\Bsig} = \SfC^e : (\dot{\BVeps} - \alpha\dot{T}\BI) - \dot{\lambda} \BP 
              = \SfC^e : \dot{\BVeps}^\alpha - \dot{\lambda} \BP\,.
\Eeq
We define
\Beq 
  \dot{\Bsig}^\Trial := \SfC^e : \dot{\BVeps}^\alpha
\Eeq
to get 
\Beq \label{eq:sig_trial}
  \dot{\Bsig} = \dot{\Bsig}^\Trial - \dot{\lambda} \BP \,.
\Eeq

\subsection{Plastic loading}
The consistency condition requires that
\Beq
  \dot{f}(\Bsig, \Bbeta, \Veps_p^\Teq, \dot{\Veps}_p^\Teq, \phi, D, T, \dots) = 0 ~.
\Eeq
For rate-independent plasticity, from the chain rule,
\Beq
  \dot{f} = \Partial{f}{\Bsig}:\dot{\Bsig} + \Partial{f}{\Bbeta}:\dot{\Bbeta} + 
    \Partial{f}{\Veps^\Teq_p}~\dot{\Veps}^\Teq_p + \Partial{f}{\phi}~\dot{\phi} +
    \Partial{f}{D}~\dot{D} + \Partial{f}{T_p}~\dot{T}_p = 0~.
\Eeq
Using the hardening/softening rules, 
\Beq
  \Partial{f}{\Bsig}:\dot{\Bsig} + \dot{\lambda}\left[\Partial{f}{\Bbeta}:\Bh^\beta + 
    \Partial{f}{\Veps^\Teq_p}~h^{\Veps_p} + \Partial{f}{\phi}~h^\phi +
    \Partial{f}{D}~h^D + \Partial{f}{T_p}~h^T\right] = 0
\Eeq
or
\Beq
  \Partial{f}{\Bsig}:\dot{\Bsig} + \dot{\lambda} H = 0 \,.
\Eeq
Define,
\Beq \label{eq:def_N_H}
  \BN := \Partial{f}{\Bsig} ~,~~ \hat{\BN} := \frac{\BN}{\Norm{\BN}{}} ~,~~
  \hat{H} := \frac{H}{\Norm{\BN}{}} \,.
\Eeq
Then,
\Beq \label{eq:consistency}
  \hat{\BN}:\dot{\Bsig} + \dot{\lambda} \hat{H} = 0 \,.
\Eeq
Combining the stress-rate equation \eqref{eq:sig_trial} with the consistency equation
\eqref{eq:consistency}, we have
\Beq
  \hat{\BN}:\dot{\Bsig}^\Trial = \hat{\BN} : \SfC^e : \dot{\BVeps}^\alpha = 
    \dot{\lambda} (\hat{\BN}:\BP - \hat{H})  \,.
\Eeq
Therefore, 
\Beq \label{eq:dot_lambda}
  \dot{\lambda} = \frac{\hat{\BN}:\dot{\Bsig}^\Trial}{\hat{\BN}:\BP - \hat{H}} 
                = \frac{\hat{\BN} : \SfC^e : \dot{\BVeps}^\alpha}{\hat{\BN}:\BP - \hat{H}} 
\Eeq
Substituting this expression to \eqref{eq:sig_trial}, we have
\Beq 
  \dot{\Bsig} = \dot{\Bsig}^\Trial - \frac{\hat{\BN}:\dot{\Bsig}^\Trial}{\hat{\BN}:\BP - \hat{H}} \BP 
     = \dot{\Bsig}^\Trial - \frac{\BP\otimes\hat{\BN}}{\hat{\BN}:\BP - \hat{H}}:\dot{\Bsig}^\Trial 
\Eeq
or,
\Beq
  \dot{\Bsig} = \SfC^e : \dot{\BVeps}^\alpha  
      - \frac{(\BP\otimes\hat{\BN}):\SfC^e}{\hat{\BN}:\BP - \hat{H}} : \dot{\BVeps}^\alpha  
     = \SfC^{ep} : \dot{\BVeps}^\alpha \,.
\Eeq
The quantity $\SfC^{ep}$ is the continuum elastic-plastic tangent modulus. 

\section{Stress update}
The first step in the stress update procedure is to compute a trial stress state from
\Beq 
  \dot{\Bsig}^\Trial = \SfC^e : \dot{\BVeps}^\alpha \,.
\Eeq
We assume that
\Beq
  \Bsig^\Trial = \Bsig_n + \Delta t (\SfC^e_n : \dot{\BVeps}^\alpha_{n+1/2}) 
\Eeq
where $\Bsig_n$ is the stress at the end of time $t_n$, $\SfC^e_n$ is the elastic modulus
at that time, $\dot{\BVeps}^\alpha_{n+1/2}$ is the strain rate computed from the symmetric
part of the unrotated veocity gradient, and $\Delta t = t_{n+1} - t_n$ is the timestep size.

The trial state contains the vector
\Beq
  \Beta^\Trial = 
    \left[\Bsig^\Trial, \Bbeta_n, (\Veps^\Teq_p)_n, (\dot{\Veps}^\Teq_p)_n,
           \phi_n, D_n, T_n, \kappa_n, \mu_n, \dots\right].
\Eeq
where the subscript ($n$) indicates the state at the end of time $t_n$.

The trial state is used to compute the yield function
\Beq
  f_y = f[\Bsig^\Trial, \Bbeta_n, (\Veps^\Teq_p)_n, 
          (\dot{\Veps}^\Teq_p)_n, \phi_n, D_n, T_n, \kappa_n, \mu_n, \dots]
\Eeq
If $f_y \le 0$, the trial state is in the elastic regime and we update the stress using
\Beq
  \Bal
  &\Bsig_{n+1} = \Bsig^\Trial~,~~\Bbeta_{n+1} = \Bbeta_n ~,~~(\Veps^\Teq_p)_{n+1} = (\Veps^\Teq_p)_n
  ~,~~ (\dot{\Veps}^\Teq_p)_{n+1} = (\dot{\Veps}^\Teq_p)_n \\
  &\phi_{n+1} = \phi_n
  ~,~~ D_{n+1} = D_n ~,~~ T_{n+1} = T_n \\
  &\kappa_{n+1} = \kappa(p_{n+1}, T_n) ~,~~
  \mu_{n+1} = \mu(p_{n+1}, T_n) \,.
  \Eal
\Eeq
If $f_y > 0$, the trial state is outside the yield surface in the elastic-plastic regime.  We
can used a backward Euler algorithm to compute the updated stress state:
\Beq
  \frac{\Bsig_{n+1} - \Bsig_{n}}{\Delta t} = \frac{\Bsig^\Trial - \Bsig_n}{\Delta t} - \frac{\lambda_{n+1} - \lambda_n}{\Delta t} \BP_{n+1} 
\Eeq
or
\Beq
  \Bsig_{n+1} = \Bsig^\Trial - \Delta\lambda_{n+1} \BP_{n+1} \,.
\Eeq
The plastic strain and the internal variables can similarly be updated using
\Beq
  \Bal
    \BVeps^p_{n+1} &= \BVeps^p_n &+& \Delta\lambda_{n+1}~\BM_{n+1} \\
    (\Veps^\Teq_p)_{n+1} &= (\Veps^\Teq_p)_n &+& \Delta\lambda_{n+1}~h^{\Veps_p}_{n+1} \\
    \Bbeta_{n+1} & = \Bbeta_n &+& \Delta\lambda_{n+1}~\Bh^{\beta}_{n+1} \\
    \phi_{n+1} & = \phi_n &+& \Delta\lambda_{n+1}~h^{\phi}_{n+1} \\
    D_{n+1} & = D_n &+& \Delta\lambda_{n+1}~h^D_{n+1} \\
    (T_p)_{n+1} & = (T_p)_n &+& \Delta\lambda_{n+1}~h^T_{n+1} \,.
  \Eal
\Eeq
In addition, the stress state has to lie on the yield surface:
\Beq
  f(\Bsig^\Trial - \Delta\lambda_{n+1} \BP_{n+1}) = 0 \,.
\Eeq
Finally, the consistency condition needs to be satisfied:
\Beq
  \hat{\BN}_{n+1} : (\Bsig_{n+1} - \Bsig_n) + \Delta \lambda_{n+1} \hat{H}_{n+1}  = 0
\Eeq
or,
\Beq
  \hat{\BN}_{n+1} : (\Bsig^\Trial - \Bsig_n) = \Delta \lambda_{n+1} (\hat{\BN}_{n+1}:\BP_{n+1} - \hat{H}_{n+1})\,.
\Eeq

\subsection{Newton solve}
\Vaango assumes associated plasticity for isotropic metals, i.e., $\BM = \hat{\BN}$.  Therefore,
the following coupled equations, not all of which are independent, have to be solved for 
$\Gamma := \Delta\lambda_{n+1}$ and the updated state
$\left[\Bsig_{n+1}, \kappa_{n+1}, \mu_{n+1}, \BVeps^p_{n+1}, (\Veps^\Teq_p)_{n+1}, \Bbeta_{n+1}, 
       \phi_{n+1}, D_{n+1}, (T_p)_{n+1}\right]$:
\Beq \label{eq:coupled_metal}
  \Bal
  \Bsig_{n+1} & = \Bsig^\Trial - \Gamma \BP_{n+1} \\
  \BVeps^p_{n+1} &= \BVeps^p_n + \Gamma \hat{\BN}_{n+1} \\
  \Bbeta_{n+1} & = \Bbeta_n + \Gamma \Bh^{\beta}_{n+1} \\
  (\Veps^\Teq_p)_{n+1} &= (\Veps^\Teq_p)_n + \Gamma h^{\Veps_p}_{n+1} \\
  \phi_{n+1} & = \phi_n + \Gamma h^{\phi}_{n+1} \\
  D_{n+1} & = D_n + \Gamma h^D_{n+1} \\
  (T_p)_{n+1} & = (T_p)_n + \Gamma h^T_{n+1} \\
  \hat{\BN}_{n+1} &: (\Bsig^\Trial - \Bsig_n) - \Gamma (\hat{\BN}_{n+1}:\BP_{n+1} - \hat{H}_{n+1})  = 0\\
  f_{n+1} &= f(\Bsig^\Trial - \Gamma \BP_{n+1}) = 0 \\
  \BP_{n+1}   & = \SfC^e_{n+1} : \hat{\BN}_{n+1} - 
                  \left.\Partial{\Bsig}{\Bbeta}\right|_{n+1} : \Bh^\beta_{n+1} -   
                  \left.\Partial{\Bsig}{\Veps^\Teq_p}\right|_{n+1}  h^{\Veps_p}_{n+1} -         
                  \left.\Partial{\Bsig}{\phi}\right|_{n+1} h^\phi_{n+1} -       
                  \left.\Partial{\Bsig}{D}\right|_{n+1} h^D_{n+1} -        
                  \left.\Partial{\Bsig}{T_p}\right|_{n+1} h^T_{n+1} \\
  \hat{\BN}_{n+1} &= \frac{\BN_{n+1}}{\Norm{\BN_{n+1}}{}} ~,~~
  \BN_{n+1}  = \left.\Partial{f}{\Bsig}\right|_{n+1} \\
  \hat{H}_{n+1} &= \frac{H_{n+1}}{\Norm{\BN_{n+1}}{}} ~,~~
  H_{n+1}  = \left.\Partial{f}{\Bbeta}\right|_{n+1}:\Bh^\beta_{n+1} + 
                    \left.\Partial{f}{\Veps^\Teq_p}\right|_{n+1}~h^{\Veps_p}_{n+1} + 
                    \left.\Partial{f}{\phi}\right|_{n+1}~h^\phi_{n+1} +
                    \left.\Partial{f}{D}\right|_{n+1}~h^D_{n+1} + 
                    \left.\Partial{f}{T_p}\right|_{n+1}~h^T_{n+1} \,.
  \Eal
\Eeq
Let us express the stresses and strains as vectors:
\Beq
  \BSv := \left[\sigma_{11}, \sigma_{22}, \sigma_{33}, \sqrt{2}\sigma_{23}, \sqrt{2}\sigma_{31}, 
               \sqrt{2}\sigma_{12}\right] \\
  \BEv^p := \left[\Veps^p_{11}, \Veps^p_{22}, \Veps^p_{33}, \sqrt{2}\Veps^p_{23}, \sqrt{2}\Veps^p_{31}, 
               \sqrt{2}\Veps^p_{12}\right] \,.
\Eeq
We can also write
\Beq
  \BNv :=  \left[\Partial{f}{\sigma_{11}}, \Partial{f}{\sigma_{22}}, \Partial{f}{\sigma_{33}}, 
                 \sqrt{2}\Partial{f}{\sigma_{23}}, \sqrt{2}\Partial{f}{\sigma_{31}}, 
                 \sqrt{2}\Partial{f}{\sigma_{12}}\right] ~,~~ \hat{\BNv} = \frac{\BNv}{\Norm{\BNv}{}} \,.
\Eeq
Because of the isotropy of the elasticity tensor, we have
\Beq
  \Bal
  \SfC^e : \hat{\BN} = \BCv &= 
    \left[2\mu N_1 + (\kappa -\tfrac{2}{3}\mu) (N_1+N_2+N_3), 
          2\mu N_2 + (\kappa -\tfrac{2}{3}\mu) (N_1+N_2+N_3), \right.\\
    &\left. \quad      2\mu N_3 + (\kappa -\tfrac{2}{3}\mu) (N_1+N_2+N_3), 
          2\sqrt{2} \mu N_{4}, 2\sqrt{2} \mu N_{5}, 2\sqrt{2} \mu N_{6}\right] 
  \Eal
\Eeq
where $N_i$ are the components of the vector $\hat{\BNv}$.
If we ignore the elastic-plastic coupling term $\partial \Bsig/\partial \Bbeta$, and define
\Beq
  \Bal
  \BZv^{\Veps_p} &:= 
    \left[\Partial{\sigma_{11}}{\Veps_p^\Teq} h^{\Veps_p}, \Partial{\sigma_{22}}{\Veps_p^\Teq} h^{\Veps_p}, 
          \Partial{\sigma_{33}}{\Veps_p^\Teq} h^{\Veps_p}, \sqrt{2}\Partial{\sigma_{23}}{\Veps_p^\Teq} h^{\Veps_p}, 
          \sqrt{2}\Partial{\sigma_{31}}{\Veps_p^\Teq} h^{\Veps_p}, \sqrt{2}\Partial{\sigma_{12}}{\Veps_p^\Teq} h^{\Veps_p}\right] \\
  \BZv^{\phi} &:= 
    \left[\Partial{\sigma_{11}}{\phi} h^{\phi}, \Partial{\sigma_{22}}{\phi} h^{\phi}, 
          \Partial{\sigma_{33}}{\phi} h^{\phi}, \sqrt{2}\Partial{\sigma_{23}}{\phi} h^{\phi}, 
          \sqrt{2}\Partial{\sigma_{31}}{\phi} h^{\phi}, \sqrt{2}\Partial{\sigma_{12}}{\phi} h^{\phi}\right] \\
  \BZv^{D} &:= 
    \left[\Partial{\sigma_{11}}{D} h^D, \Partial{\sigma_{22}}{D} h^D, 
          \Partial{\sigma_{33}}{D} h^D, \sqrt{2}\Partial{\sigma_{23}}{D} h^D, 
          \sqrt{2}\Partial{\sigma_{31}}{D} h^D, \sqrt{2}\Partial{\sigma_{12}}{D} h^D\right] \\
  \BZv^{T_p} &:= 
    \left[\Partial{\sigma_{11}}{T_p} h^T, \Partial{\sigma_{22}}{T_p} h^T, 
          \Partial{\sigma_{33}}{T_p} h^T, \sqrt{2}\Partial{\sigma_{23}}{T_p} h^T, 
          \sqrt{2}\Partial{\sigma_{31}}{T_p} h^T, \sqrt{2}\Partial{\sigma_{12}}{T_p} h^T\right] 
  \Eal
\Eeq
we have
\Beq
  \BPv = \BCv - \BZv^{\Veps_p} - \BZv^{\phi} - \BZv^D - \BZv^{T_p} \,.
\Eeq
Noting that $\Bbeta$ is required to be symmetric for the conservation of angular momentum, we
can express the internal variables as a vector such that
\Beq
  \Bal
  \BQv &:= \left[\beta_{11}, \beta_{22}, \beta_{33}, \sqrt{2}\beta_{23}, \sqrt{2}\beta_{31}, \sqrt{2}\beta_{12},
                \Veps^\Teq_p, \phi, D, T_p\right] \\
  \BHv &:= \left[h^\beta_{11}, h^\beta_{22}, h^\beta_{33}, \sqrt{2}h^\beta_{23}, \sqrt{2}h^\beta_{31}, 
                    \sqrt{2}h^\beta_{12}, h^{\Veps_p}, h^\phi, h^D, h^T\right] \\
  \Partial{f}{\BQv} &:= \left[\Partial{f}{\beta_{11}}, \Partial{f}{\beta_{22}}, \Partial{f}{\beta_{33}}, 
                    \sqrt{2}\Partial{f}{\beta_{23}}, \sqrt{2}\Partial{f}{\beta_{31}}, 
                    \sqrt{2}\Partial{f}{\beta_{12}}, \Partial{f}{\Veps_p^\Teq}, \Partial{f}{\phi}, 
                    \Partial{f}{D}, \Partial{f}{T_p}\right] \\
  \Eal
\Eeq
Therefore,
\Beq
  H = \Partial{f}{\BQv} \cdot \BHv ~,~~ \hat{H} = \frac{H}{\Norm{\BNv}{}}\,.
\Eeq
Then \eqref{eq:coupled_metal}, can be written in vector form as
\Beq
  \Bal
  \BSv_{n+1} & = \BSv^\Trial - \Gamma \BPv_{n+1} \\
  \BEv^p_{n+1} &= \BEv^p_n + \Gamma \hat{\BNv}_{n+1} \\
  \BQv_{n+1} & = \BQv_n + \Gamma \BHv_{n+1} \\
  \hat{\BNv}_{n+1} \cdot & (\BSv^\Trial - \BSv_n) - \Gamma (\hat{\BNv}_{n+1}\cdot\BPv_{n+1} - \hat{H}_{n+1})  = 0\\
  f_{n+1} &= f(\BSv^\Trial - \Gamma \BPv_{n+1}) = 0 \,.
  \Eal
\Eeq
Since $\BPv = \BPv(\BSv, \BEv^p, \BQv)$, $\BNv = \BNv(\BSv, \BEv^p, \BQv)$, $\BHv = \BHv(\BSv, \BEv^p, \BQv)$, 
and $H = H(\BSv, \BEv^p, \BQv)$, we can write the equations above as residuals:
\Beq
  \Bal
  \Brv_S(\Gamma,\BSv,\BEv^p,\BQv) & := -\BSv_{n+1} + \BSv^\Trial - \Gamma \BPv_{n+1}(\BSv,\BEv^p, \BQv) = \Bzero  \\
  \Brv_E(\Gamma,\BSv,\BEv^p,\BQv) & := -\BEv^p_{n+1} + \BEv^p_n + \Gamma \hat{\BNv}_{n+1}(\BSv,\BEv^p, \BQv) = \Bzero \\
  \Brv_q(\Gamma,\BSv,\BEv^p,\BQv) & := -\BQv_{n+1} + \BQv_n + \Gamma \BHv_{n+1} (\BSv,\BEv^p, \BQv) = \Bzero \\
  r_f(\Gamma,\BSv,\BEv^p,\BQv) &:= f[\BSv^\Trial - \Gamma \BPv_{n+1}(\BSv,\BEv^p, \BQv)] = 0 \quad \text{where} \quad
  \Gamma = \frac{\hat{\BNv}_{n+1}\cdot (\BSv^\Trial - \BSv_n)}  
                 {\left(\hat{\BNv}_{n+1}\cdot\BPv_{n+1} - \hat{H}_{n+1}\right)}\,.
  \Eal
\Eeq
First-order Taylor series expansions of these functions at $(\Gamma,\BSv_n,\BEv^p_n,\BQv_n)$, give
\Beq
  \Bal
  \Brv_S(\Gamma,\BSv,\BEv^p,\BQv) & \approx \Brv_S(\Gamma,\BSv_n,\BEv^p_n,\BQv_n) + \\
                        &\quad       \left.\Partial{\Brv_S}{\Gamma}\right|_n (\Gamma - \Gamma_n) + 
                                     \left.\Partial{\Brv_S}{\BSv}\right|_n\cdot(\BSv - \BSv_n) + 
                                     \left.\Partial{\Brv_S}{\BEv^p}\right|_n\cdot(\BEv^p - \BEv^p_n) + 
                                     \left.\Partial{\Brv_S}{\BQv}\right|_n\cdot(\BQv - \BQv_n) \\
  \Brv_E(\Gamma,\BSv,\BEv^p,\BQv) & \approx \Brv_E(\Gamma,\BSv_n,\BEv^p_n,\BQv_n) + \\
                        &\quad       \left.\Partial{\Brv_Q}{\Gamma}\right|_n (\Gamma - \Gamma_n) + 
                                     \left.\Partial{\Brv_Q}{\BSv}\right|_n\cdot(\BSv - \BSv_n) + 
                                     \left.\Partial{\Brv_Q}{\BEv^p}\right|_n\cdot(\BEv^p - \BEv^p_n) + 
                                     \left.\Partial{\Brv_Q}{\BQv}\right|_n\cdot(\BQv - \BQv_n) \\
  \Brv_Q(\Gamma,\BSv,\BEv^p,\BQv) & \approx \Brv_Q(\Gamma,\BSv_n,\BEv^p_n,\BQv_n) + \\
                        &\quad       \left.\Partial{\Brv_E}{\Gamma}\right|_n (\Gamma - \Gamma_n) + 
                                     \left.\Partial{\Brv_E}{\BSv}\right|_n\cdot(\BSv - \BSv_n) + 
                                     \left.\Partial{\Brv_E}{\BEv^p}\right|_n\cdot(\BEv^p - \BEv^p_n) + 
                                     \left.\Partial{\Brv_E}{\BQv}\right|_n\cdot(\BQv - \BQv_n) \\
  r_f(\Gamma,\BSv,\BEv^p,\BQv)    & \approx r_f(\Gamma,\BSv_n,\BEv^p_n,\BQv_n) + \\
                        &\quad       \left.\Partial{r_f}{\Gamma}\right|_n (\Gamma - \Gamma_n) + 
                                     \left.\Partial{r_f}{\BSv}\right|_n\cdot(\BSv - \BSv_n) + 
                                     \left.\Partial{r_f}{\BEv^p}\right|_n\cdot(\BEv^p - \BEv^p_n) + 
                                     \left.\Partial{r_f}{\BQv}\right|_n\cdot(\BQv - \BQv_n) 
  \Eal
\Eeq
Since the residuals are required to be zero at the end of the timestep, we get the following 
rule for the $k$-th iteration, 
\Beq
  \Bal
    &\left.\Partial{\Brv_S}{\Gamma}\right|_k \Delta\Gamma + 
    \left.\Partial{\Brv_S}{\BSv}\right|_{k}\cdot \Delta\BSv + 
    \left.\Partial{\Brv_S}{\BEv^p}\right|_{k}\cdot \Delta\BEv^p + 
    \left.\Partial{\Brv_S}{\BQv}\right|_{k}\cdot \Delta\BQv = -\Brv_S(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    &\left.\Partial{\Brv_E}{\Gamma}\right|_k \Delta\Gamma + 
    \left.\Partial{\Brv_E}{\BSv}\right|_{k}\cdot \Delta\BSv + 
    \left.\Partial{\Brv_E}{\BEv^p}\right|_{k}\cdot \Delta\BEv^p + 
    \left.\Partial{\Brv_E}{\BQv}\right|_{k}\cdot \Delta\BQv = -\Brv_E(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    &\left.\Partial{\Brv_Q}{\Gamma}\right|_k  \Delta\Gamma + 
    \left.\Partial{\Brv_Q}{\BSv}\right|_{k}\cdot \Delta\BSv + 
    \left.\Partial{\Brv_Q}{\BEv^p}\right|_{k}\cdot \Delta\BEv^p + 
    \left.\Partial{\Brv_Q}{\BQv}\right|_{k}\cdot \Delta\BQv = -\Brv_Q(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    &\left.\Partial{r_f}{\Gamma}\right|_k  \Delta\Gamma +
    \left.\Partial{r_f}{\BSv}\right|_{k}\cdot \Delta\BSv +
    \left.\Partial{r_f}{\BEv^p}\right|_{k}\cdot \Delta\BEv^p +
    \left.\Partial{r_f}{\BQv}\right|_{k}\cdot \Delta\BQv = -r_f(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) 
  \Eal
\Eeq
where
\Beq
  \Delta\Gamma = \Gamma_{k+1} - \Gamma_k~,~~
  \Delta\BSv = \BSv_{k+1} - \BSv_k~,~~
  \Delta\BEv^p = \BEv^p_{k+1} - \BEv^p_k~,~~
  \Delta\BQv = \BQv_{k+1} - \BQv_k \,.
\Eeq
The derivatives of the residuals are (dropping subscripts $n+1$ for convenience), 
\Beq
  \Bal
  &\Partial{\Brv_S}{\Gamma} = -\BPv ~,~~
  \Partial{\Brv_E}{\Gamma} = \hat{\BNv} ~,~~
  \Partial{\Brv_Q}{\Gamma} = \BHv ~,~~
  \Partial{r_f}{\Gamma} = -\Partial{f}{\BSv} \cdot \BPv  \\
  &\Partial{\Brv_S}{\BSv} = -\MI - \Gamma \Partial{\BPv}{\BSv} ~,~~
  \Partial{\Brv_E}{\BSv} = \Gamma \Partial{\hat{\BNv}}{\BSv} ~,~~
  \Partial{\Brv_Q}{\BSv} = \Gamma \Partial{\BHv}{\BSv} ~,~~
  \Partial{r_f}{\BSv} = \Partial{f}{\BSv}  \\
  &\Partial{\Brv_S}{\BEv^p} = - \Gamma \Partial{\BPv}{\BEv^p} ~,~~
  \Partial{\Brv_E}{\BEv^p} = -\MI + \Gamma \Partial{\hat{\BNv}}{\BEv^p} ~,~~
  \Partial{\Brv_Q}{\BEv^p} = \Gamma \Partial{\BHv}{\BEv^p} ~,~~
  \Partial{r_f}{\BEv^p} = \Partial{f}{\BEv^p}  \\
  &\Partial{\Brv_S}{\BQv} = - \Gamma \Partial{\BPv}{\BQv} ~,~~
  \Partial{\Brv_E}{\BQv} = \Gamma \Partial{\hat{\BNv}}{\BQv} ~,~~
  \Partial{\Brv_Q}{\BQv} = -\MI + \Gamma \Partial{\BHv}{\BQv} ~,~~
  \Partial{r_f}{\BQv} = \Partial{f}{\BQv} 
  \Eal
\Eeq
Therefore, using $\BNv = \partial f/\partial \BSv$, 
\Beq
  \Bal
    &-\BPv_k \Delta\Gamma  
     -\left(\MI + \Gamma_k \left.\Partial{\BPv}{\BSv}\right|_k\right)\cdot \Delta\BSv 
     -\Gamma_k \left.\Partial{\BPv}{\BEv^p}\right|_k \cdot \Delta\BEv^p  
     -\Gamma_k \left.\Partial{\BPv}{\BQv}\right|_k\cdot \Delta\BQv = -\Brv_S(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    & \hat{\BNv}_k \Delta\Gamma  
     +\Gamma_k \left.\Partial{\hat{\BNv}}{\BSv}\right|_k\cdot \Delta\BSv  
     -\left(\MI - \Gamma_k \left.\Partial{\hat{\BNv}}{\BEv^p}\right|_k\right)\cdot \Delta\BEv^p 
     +\Gamma_k \left.\Partial{\hat{\BNv}}{\BQv}\right|_k\cdot \Delta\BQv = -\Brv_E(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    & \BHv_k  \Delta\Gamma  
     +\Gamma_k \left.\Partial{\BHv}{\BSv}\right|_{k}\cdot \Delta\BSv  
     +\Gamma_k \left.\Partial{\BHv}{\BEv^p}\right|_k\cdot \Delta\BEv^p  
     -\left(\MI - \Gamma_k \left.\Partial{\BHv}{\BQv}\right|_k\right)\cdot \Delta\BQv = -\Brv_Q(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    &-\BNv_k \cdot \BPv_k  \Delta\Gamma
     +\BNv_k \cdot \Delta\BSv 
     +\left.\Partial{f}{\BEv^p}\right|_k\cdot \Delta\BEv^p 
     +\left.\Partial{f}{\BQv}\right|_k\cdot \Delta\BQv = -r_f(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k)
  \Eal
\Eeq
Because the derivatives of $\hat{\BNv}$, $\BPv$, $\BHv$ with respect 
to $\BSv$, $\BEv^p$, $\BQv$ may be difficult to calculate, it is more convenient
to use a semi-implicit scheme where the quantities $\hat{\BNv}$, $\BPv$, $\BHv$ are evaluated 
at $t_n$.  In that case we have
\Beq
  \Bal
    &-\BPv_k \Delta\Gamma  
     -\Delta\BSv 
     = -\Brv_S(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    & \hat{\BNv}_k \Delta\Gamma  
     -\Delta\BEv^p 
     = -\Brv_E(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    & \BHv_k  \Delta\Gamma  
     -\Delta\BQv 
     = -\Brv_Q(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k) \\
    &-\BNv_k \cdot \BPv_k  \Delta\Gamma
     +\BNv_k \cdot \Delta\BSv 
     +\left.\Partial{f}{\BEv^p}\right|_k\cdot \Delta\BEv^p 
     +\left.\Partial{f}{\BQv}\right|_k\cdot \Delta\BQv = -r_f(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k)
  \Eal
\Eeq
We now force $\Brv_S$, $\Brv_E$, and $\Brv_Q$ to be zero at all times, leading
to the expressions
\Beq
  \Bal
    &\Delta\BSv = -\BPv_k \Delta\Gamma  \\
    &\Delta\BEv^p = \hat{\BNv}_k \Delta\Gamma  \\
    &\Delta\BQv = \BHv_k  \Delta\Gamma  \\
    &r_f(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k)
     -\BNv_k \cdot \BPv_k  \Delta\Gamma
     +\BNv_k \cdot \Delta\BSv 
     +\left.\Partial{f}{\BEv^p}\right|_k\cdot \Delta\BEv^p 
     +\left.\Partial{f}{\BQv}\right|_k\cdot \Delta\BQv = 0
  \Eal
\Eeq
Plugging the expressions for $\Delta\BSv$, $\Delta\BEv^p$, $\Delta\BQv$ from the 
first three equations into the fourth gives us
\Beq
  r_f(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k)
     -2 \BNv_k \cdot \BPv_k  \Delta\Gamma
     +\left.\Partial{f}{\BEv^p}\right|_k\cdot \hat{\BNv}_k\Delta\Gamma
     +\left.\Partial{f}{\BQv}\right|_k\cdot \BHv_k\Delta\Gamma = 0
\Eeq
or
\Beq
  \Delta\Gamma = \frac{r_f(\Gamma_k,\BSv_k,\BEv^p_k,\BQv_k)}
                      {2 \BNv_k \cdot \BPv_k
                       +\left.\Partial{f}{\BEv^p}\right|_k\cdot \hat{\BNv}_k
                       +\left.\Partial{f}{\BQv}\right|_k\cdot \BHv_k}
\Eeq

\subsection{Algorithm}
The following stress update algorithm is used for each (plastic) time step:
\begin{enumerate}
  \item Initialize:
  \Beq
    k = 0 ~;~~ (\Ve^p)^{(k)} = \Ve^p_n ~;~~ \phi^{(k)} = \phi_n ~;~~
    \Bbeta^{(k)} = \Bbeta_n ~;~~ \Delta\gamma^{(k)} = 0 ~;~~
    \Bxi^{(k)} = \Bxi^{\Trial}~.
  \Eeq
  \item Check yield condition:
  \Beq
    f^{(k)} := f(\Bxi^{(k)}, (\Ve^p)^{(k)}, \phi^{(k)}, \dot{\Ve}_n, T_n, \dots)
  \Eeq
  If $f^{(k)} < \text{tolerance}$ then 
  go to step 5 else go to step 3.
  \item Compute updated $\delta\gamma^{(k)}$ using
  \Beq
    \delta\gamma^{(k)} = 
     \cfrac{f^{(k)}}
     {\Partial{f^{(k)}}{\Bxi}:[2~\mu~\Dev(\Br_n) + \Dev(\Bh^{\beta}_n)] - 
     h^{\alpha}_n~\Partial{f^{(k)}}{\Ve^p} - 
     h^{\phi}_n~\Partial{f^{(k)}}{\phi}} ~.
  \Eeq
  Compute
  \Beq
  \Bal
    \Delta\Bxi^{(k)} & = -[2~\mu~\Dev(\Br_n) + \Dev(\Bh^{\beta}_n)]~\delta\gamma^{(k)} \\
    (\Delta\Ve^p)^{(k)} & =  h^{\alpha}_n~\delta\gamma^{(k)}   \\
    \Delta\phi^{(k)} & =  h^{\phi}_n~\delta\gamma^{(k)}   
  \Eal
  \Eeq
  \item Update variables:
  \Beq
    \Bal
    (\Ve^p)^{(k+1)} & = (\Ve^p)^{(k)} + (\Delta\Ve^p)^{(k)} \\
    \phi^{(k+1)} & = \phi^{(k)} + \Delta\phi^{(k)} \\
    \Bxi^{(k+1)} & = \Bxi^{(k)} + \Delta\Bxi^{(k)} \\
    \Delta\gamma^{(k+1)} & = \Delta\gamma^{(k)} + \delta\gamma^{(k)}
    \Eal
  \Eeq
  Set $k \leftarrow k+1$ and go to step 2.
  \item Update and calculate back stress and the deviatoric part of Cauchy stress:
  \Beq
    \Ve^p_{n+1} = (\Ve^p)^{(k)} ~;~~
    \phi_{n+1} = \phi^{(k)} ~;~~
    \Bxi_{n+1} = \Bxi^{(k)} ~;~~
    \Delta\gamma_{n+1} = \Delta\gamma^{(k)}
  \Eeq
  and
  \Beq
    \Bal
    \widehat{\Bbeta}_{n+1} & = \widehat{\Bbeta}_n + \Delta\gamma_{n+1}~\Bh^{\beta}(\Bxi_{n+1}, \Ve^p_{n+1}, \phi_{n+1}) \\
    \Bbeta_{n+1} & = \widehat{\Bbeta}_{n+1} - \Third~\Tr(\widehat{\Bbeta}_{n+1})~\BI \\
    \Bs_{n+1} & = \Bxi_{n+1} + \Bbeta_{n+1}
    \Eal
  \Eeq
  \item Update the temperature and the Cauchy stress
  \Beq
    \Bal
    T_{n+1} & = T_n + 
     \cfrac{\chi_{n+1}~\Delta t}{\rho_{n+1}~C_p}~\sigma^{n+1}_y~\dot{\Ve^p}_{n+1} 
     = T_n + 
     \cfrac{\chi_{n+1}~\Delta\gamma_{n+1}}{\rho_{n+1}~C_p}~\sigma^{n+1}_y~h^{\alpha}_{n+1} \\
    p_{n+1} & = p(J_{n+1}) \\ 
    \kappa_{n+1} & = J_{n+1}~\left[\Deriv{p(J)}{J}\right]_{n+1} \\
    \Bsig_{n+1} & = \left[p_{n+1} - 3~\kappa_{n+1}~\alpha~(T_{n+1}-T_0)\right]~\BI + \Bs_{n+1}
    \Eal
  \Eeq
\end{enumerate}

\section{Examples}
Let us now look at a few examples.
\subsection{Example 1}
Consider the case of $J_2$ plasticity with the yield condition
\Beq
  f := \sqrt{\frac{3}{2}} \Norm{\Bs-\Bbeta}{} - \sigma_y(\Ve^p, \dot{\Ve}, T, \dots) = 
       \sqrt{\frac{3}{2}} \Norm{\Bxi}{} - \sigma_y(\Ve^p, \dot{\Ve}, T, \dots) \le 0 
\Eeq
where $\Norm{\Bxi} = \sqrt{\Bxi:\Bxi}$. Assume the associated flow rule
\Beq
  \Bd^p = \dot{\gamma}~\Br = \dot{\gamma}~\Partial{f}{\Bsig} = \dot{\gamma}~\Partial{f}{\Bxi} ~.
\Eeq
Then
\Beq
  \Br = \Partial{f}{\Bxi} = \sqrt{\frac{3}{2}}~\cfrac{\Bxi}{\Norm{\Bxi}{}} 
\Eeq
and
\Beq
  \Bd^p = \sqrt{\frac{3}{2}}~\dot{\gamma}~\cfrac{\Bxi}{\Norm{\Bxi}{}} ~;~~
  \Norm{\Bd^p}{} = \sqrt{\frac{3}{2}}~\dot\gamma ~.
\Eeq
The evolution of the equivalent plastic strain is given by
\Beq
  \dot{\Ve^p} = \dot{\gamma}~h^{\alpha} = \sqrt{\cfrac{2}{3}}~\Norm{\Bd^p}{} = \dot{\gamma}~.
\Eeq
This definition is consistent with the definition of equivalent plastic strain
\Beq
  \Ve^p = \int_0^t \dot{\Ve}^p~d\tau = 
   \int_0^t \sqrt{\cfrac{2}{3}}~\Norm{\Bd^p}{}~d\tau ~.
\Eeq
The evolution of porosity is given by (there is no evolution of porosity)
\Beq
  \dot{\phi} = \dot{\gamma}~h^{\phi} = 0
\Eeq
The evolution of the back stress is given by the Prager kinematic hardening rule
\Beq
  \dot{\widehat{\Bbeta}} = \dot{\gamma}~\Bh^{\beta} = \frac{2}{3}~H'~\Bd^p 
\Eeq
where $\widehat{\Bbeta}$ is the back stress and
$H'$ is a constant hardening modulus.  Also, the trace of $\Bd^p$ is 
\Beq
  \Tr(\Bd^p) = \sqrt{\frac{3}{2}}~\dot{\gamma}~\cfrac{\Tr(\Bxi)}{\Norm{\Bxi}{}}~.
\Eeq
Since $\Bxi$ is deviatoric, $\Tr(\Bxi) = 0$ and hence $\Bd^p = \Beta^p$.
Hence, $\widehat{\Bbeta} = \Bbeta$ (where $\Bbeta$ is the deviatoric part of $\widehat{\Bbeta}$), and
\Beq
  \dot{\Bbeta} = \sqrt{\frac{2}{3}}~H'~\dot{\gamma}~\cfrac{\Bxi}{\Norm{\Bxi}{}} ~.
\Eeq

These relation imply that
\Beq
  \boxed{
  \Bal
    \Br & = \sqrt{\frac{3}{2}}~\cfrac{\Bxi}{\Norm{\Bxi}{}} \\
     h^{\alpha} & = 1 \\
     h^{\phi} & = 0 \\
    \Bh^{\beta} & = \sqrt{\frac{2}{3}}~H'~\cfrac{\Bxi}{\Norm{\Bxi}{}} ~.
  \Eal
  }
\Eeq
We also need some derivatives of the yield function.  These are
\Beq
  \Bal
  \Partial{f}{\Bxi} & = \Br \\
  \Partial{f}{\Ve^p} & = -\Partial{\sigma_y}{\Ve^p} \\
  \Partial{f}{\phi} & = 0 ~.
  \Eal
\Eeq

Let us change the kinematic hardening model and use the Armstrong-Frederick
model instead, i.e.,
\Beq
  \dot{\Bbeta} = \dot{\gamma}~\Bh^{\beta} = \frac{2}{3}~H_1~\Bd^p - H_2~\Bbeta~\Norm{\Bd^p}{} ~.
\Eeq
Since
\Beq
  \Bd^p = \sqrt{\frac{3}{2}}~\dot{\gamma}~\cfrac{\Bxi}{\Norm{\Bxi}{}}
\Eeq
we have
\Beq
  \Norm{\Bd^p}{} = 
   \sqrt{\frac{3}{2}}~\dot{\gamma}~\cfrac{\Norm{\Bxi}{}}{\Norm{\Bxi}{}} = 
   \sqrt{\frac{3}{2}}~\dot{\gamma} ~.
\Eeq
Therefore,
\Beq
  \dot{\Bbeta} = \sqrt{\frac{2}{3}}~H_1~\dot{\gamma}~\cfrac{\Bxi}{\Norm{\Bxi}{}} 
    - \sqrt{\frac{3}{2}}~H_2~\dot{\gamma}~\Bbeta ~.
\Eeq
Hence we have
\Beq
  \boxed{
  \Bh^{\beta} = \sqrt{\frac{2}{3}}~H_1~\cfrac{\Bxi}{\Norm{\Bxi}{}} 
    - \sqrt{\frac{3}{2}}~H_2~\Bbeta ~.
   }
\Eeq

\subsection{Example 2}
Let us now consider a Gurson type yield condition with kinematic hardening.  In this
case the yield condition can be written as
\Beq
  f := \cfrac{3~\Bxi:\Bxi}{2~\sigma_y^2} + 
     2~q_1~\phi^{*}~\cosh\left(\cfrac{q_2~\Tr(\Bsig)}{2~\sigma_y}\right)
     - [1 + q_3~(\phi^*)^2]
\Eeq
where $\phi$ is the porosity and
\Beq
  \phi^* = \begin{cases}
             \phi & \text{for}~ \phi \le \phi_c \\
             \phi_c - \cfrac{\phi_u^* - \phi_c}{\phi_f - \phi_c}~(\phi - \phi_c) & 
              \text{for}~ \phi > \phi_c
           \end{cases}
\Eeq
Final fracture occurs for $\phi = \phi_f$ or when $\phi_u^* = 1/q_1$.  

Let us use an associated flow rule
\Beq
  \Bd^p = \dot{\gamma}~\Br = \dot{\gamma}~\Partial{f}{\Bsig} ~.
\Eeq
Then
\Beq
  \Br = \Partial{f}{\Bsig} = \cfrac{3~\Bxi}{\sigma_y^2} + \cfrac{q_1~q_2~\phi^{*}}{\sigma_y}~
   \sinh\left(\cfrac{q_2~\Tr(\Bsig)}{2~\sigma_y}\right)~\BI ~.
\Eeq
In this case
\Beq
  \Tr(\Br) = \cfrac{3~q_1~q_2~\phi^{*}}{\sigma_y}~\sinh\left(\cfrac{q_2~\Tr(\Bsig)}{2~\sigma_y}\right)
  \ne 0 
\Eeq
Therefore,
\Beq
  \Bd^p \ne \Beta^p ~.
\Eeq

For the evolution equation for the plastic strain we use
\Beq
  (\Bsig-\widehat{\Bbeta}):\Bd^p = (1 - \phi)~\sigma_y~\dot{\Ve}^p
\Eeq
where $\dot{\Ve}^p$ is the effective plastic strain rate in the matrix material.  Hence,
\Beq
  \dot{\Ve}^p = \dot{\gamma}~h^{\alpha}
    = \dot{\gamma}~\cfrac{(\Bsig - \widehat{\Bbeta}):\Br}{(1 - \phi)~\sigma_y} ~.
\Eeq

The evolution equation for the porosity is given by
\Beq
  \dot{\phi} = (1 - \phi)~\Tr(\Bd^p) + A~\dot{\Ve^p}
\Eeq
where
\Beq
A = \cfrac{f_n}{s_n \sqrt{2\pi}} \exp [-1/2 (\Ve^p - \Ve_n)^2/s_n^2]
\Eeq
and $ f_n $ is the volume fraction of void nucleating particles, 
$ \Ve_n $ is the mean of the normal distribution of nucleation strains, and 
$ s_n $ is the standard deviation of the distribution.

Therefore,
\Beq
  \dot{\phi} = \dot{\gamma}~h^{\phi} =
    \dot{\gamma}~\left[(1 - \phi)~\Tr(\Br) + A~
    \cfrac{(\Bsig - \widehat{\Bbeta}):\Br}{(1 - \phi)~\sigma_y}\right] ~.
\Eeq

If the evolution of the back stress is given by the Prager kinematic hardening rule
\Beq
  \dot{\widehat{\Bbeta}} = \dot{\gamma}~\Bh^{\beta} = \frac{2}{3}~H'~\Bd^p 
\Eeq
where $\widehat{\Bbeta}$ is the back stress, then
\Beq
  \dot{\widehat{\Bbeta}} = \frac{2}{3}~H'~\dot{\gamma}~\Br ~.
\Eeq
Alternatively, if we use the Armstrong-Frederick model, then
\Beq
  \dot{\widehat{\Bbeta}} = \dot{\gamma}~\Bh^{\beta} = 
   \frac{2}{3}~H_1~\Bd^p - H_2~\widehat{\Bbeta}~\Norm{\Bd^p}{} ~.
\Eeq
Plugging in the expression for $\Bd^p$, we have
\Beq
  \dot{\widehat{\Bbeta}} = \dot{\gamma}~
  \left[\frac{2}{3}~H_1~\Br - H_2~\widehat{\Bbeta}~\Norm{\Br}{}\right] ~.
\Eeq
Therefore, for this model,
\Beq
  \boxed{
  \Bal
  \Br & = \cfrac{3~\Bxi}{\sigma_y^2} + \cfrac{q_1~q_2~\phi^{*}}{\sigma_y}~
   \sinh\left(\cfrac{q_2~\Tr(\Bsig)}{2~\sigma_y}\right)~\BI  \\
  h^{\alpha} &  
    = \cfrac{(\Bsig - \Bbeta):\Br}{(1 - \phi)~\sigma_y} \\
  h^{\phi} & = 
    (1 - \phi)~\Tr(\Br) + A~
    \cfrac{(\Bsig - \widehat{\Bbeta}):\Br}{(1 - \phi)~\sigma_y}  \\
  \Bh^{\beta} & = 
   \frac{2}{3}~H_1~\Br - H_2~\widehat{\Bbeta}~\Norm{\Br}{}
  \Eal
  }
\Eeq
The other derivatives of the yield function that we need are
\Beq
  \Bal
  \Partial{f}{\Bxi} & = \cfrac{3~\Bxi}{\sigma_y^2} \\
  \Partial{f}{\Ve^p} & = \Partial{f}{\sigma_y}~\Partial{\sigma_y}{\Ve^p} 
   = -\left[\cfrac{3~\Bxi:\Bxi}{\sigma_y^3} +
     \cfrac{q_1~q_2~\phi^*~\Tr(\Bsig)}{\sigma_y^2}~
     \sinh\left(\cfrac{q_2~\Tr(\Bsig)}{2~\sigma_y}\right)\right]~
     \Partial{\sigma_y}{\Ve^p}\\
  \Partial{f}{\phi} & = 2~q_1~\Deriv{\phi^*}{\phi}~
    \cosh\left(\cfrac{q_2~\Tr(\sigma)}{2~\sigma_y}\right) 
    - 2~q_3~\phi^*~\Deriv{\phi^*}{\phi} ~.
  \Eal
\Eeq


