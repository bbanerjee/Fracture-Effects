\chapter{Arenisca: Partially Saturated Soils}

The convention used in Vaango is that tension is positive and compression is negative.  To keep the
notation simple  we define, for any $x$,
\Beq
  \bar{x} := -x \,,\quad \dot{x} := \Partial{x}{t}\,.
\Eeq

\section{Elasticity}
The elasticity model used by Arenisca has the form
\Beq
  \dot{\Bsig^\Teff} = \dot{\Bsig} - \dot{\Balpha} 
     = \SfC^\Te(\Bsig,\Bveps^\Tp,\phi,S_w):\dot{\Bveps^\Te} - \dot{\lambda}\BZ 
\Eeq
where $\Bsig^\Teff$ is the effective stress, 
$\Bsig$ is the unrotated Cauchy stress, $\Balpha$ is the backstress, $\SfC^\Te$ is a tangent elastic modulus
which depends on the stress (and also the plastic strain $\Bveps^\Tp$, porosity $\phi$, and 
water saturation $S_w$), the elastic strain is $\Bveps^\Te$,
$\dot{\lambda}$ is the plastic flow rate, and $\BZ$ in an elastic-plastic coupling tensor.

The model assumes that the tangent modulus tensor is isotropic and can be expressed as
\Beq
  \SfC^\Te = \left(K - \tfrac{2}{3} G\right) \BI\otimes\BI + 2G\,\SfI
\Eeq
where $K(\Bsig,\Balpha,\Bveps^\Tp,\phi,S_w)$ is the bulk modulus, 
$G(\Bsig,\Balpha,\Bveps^\Tp,\phi,S_w)$ is the shear modulus, 
$\BI$ is rank-2 identity tensor, and $\SfI$ is the symmetric part of the rank-4 identity tensor.

If the effective stress is decomposed into volumetric and deviatoric parts:
\Beq
  \Bsig^\Teff = -\pbar\,\BI + \Bs ~,~~ 
   p := \Third\Tr(\Bsig^\Teff) ~,~~ \Bs := \Bsig^\Teff - \Third\Tr(\Bsig^\Teff)\BI
\Eeq
and the elastic strain is also decomposed into volumetric and deviatoric parts
\Beq
  \Bveps^\Te = -\Third\bar{\Veps^\Te_v}\,\BI + \Bgamma^\Te ~,~~
   \Veps^\Te_v := \Tr(\Bveps^\Te) ~,~~ \Bgamma^\Te := \Bveps^\Te - \Third\Tr(\Bveps^\Te)\BI
\Eeq
the elasticity model (without the coupling term), simplifies to
\Beq
  \dot{\pbar} = K(\Bsig, \alpha, \Bveps^\Tp, \phi, S_w) \dot{\overbar{\Veps^\Te_v}}
  ~,~~ \dot{\Bs} = 2G(\Bsig, \alpha, \Bveps^\Tp, \phi, S_w) \,\dot{\Bgamma^\Te} \,.
\Eeq
The partially saturated Arenisca model assumes the moduli depend only on
\Beq
  I_1 := \Tr(\Bsig)  ~,~~ \zeta = \Tr(\Balpha) ~,~~ \Veps^\Tp_v := \Tr(\Bveps^\Tp)
  ~,~~ \phi ~,~~ S_w \,.
\Eeq

  \subsection{Bulk modulus model: Solid matrix material}
  The pressure in the solid matrix is expressed as
  \Beq \label{eq:pm}
    \pbar_s = K_s \bar{\Veps_v^s} ~;~~ \bar{\Veps_v^s} := \ln\left(\frac{V_{s0}}{V_s}\right) 
  \Eeq
  where $\pbar_s$ is the solid matrix pressure, $K_s$ is the solid bulk modulus, 
  $\bar{\Veps_v^s}$ is the volumetric strain, $V_{s0}$ is the 
  initial volume of the solid, and $V_s$ is the current volume of the solid.  The solid
  bulk modulus is assumed to modeled by the Murnaghan equation:
  \Beq
    K_s(\pbar_s) = K_{s0} + n_s\,(\pbar_s - \pbar_{s0})
  \Eeq
  where $K_{s0}$ and $n_s$ are material properties, and $\pbar_{s0}$ is a reference pressure. 

  \subsection{Bulk modulus model: Pore water}
  The equation of state of the pore water is
  \Beq \label{eq:pw}
    \pbar_w = K_w \bar{\Veps_v^w} + \pbar_0 ~;~~ \bar{\Veps_v^w} := \ln\left(\frac{V_{w0}}{V_w}\right)
  \Eeq
  where $\pbar_w$ is the water pressure, $K_w$ is the water bulk modulus, $V_{w0}$ is the 
  initial volume of water, $V_w$ is the current volume of water, $\pbar_0$ is the
  initial water pressure, and $\bar{\Veps}_v^w$ is the volumetric strain in the water.  We use the
  isothermal Murnaghan bulk modulus model for water:
  \Beq
    K_w(\pbar_w) = K_{w0} + n_w\,(\pbar_w - \pbar_{w0})
  \Eeq
  where $K_{w0}$ and $n_w$ are material properties, and $\pbar_{w0}$ is a reference pressure. 

  \subsection{Bulk modulus model: Pore air}
  The isentropic ideal gas equation of state for the pore air is
  \Beq\label{eq:pa_alt}
    \pbar_a = \pbar_r\left[\exp(\gamma\,\bar{\Veps_v^a}) - 1 \right]
    ~;~~ \bar{\Veps_v^a} := \ln\left(\frac{V_{a0}}{V_a}\right) 
  \Eeq
  where the quantities with subscript $a$ represent quantities for the air model analogous to those 
  for the water model in~\eqref{eq:pw}, $\pbar_r$ is a reference pressure (101325 Pa) and $\gamma = 1.4$.
  The bulk modulus of air ($K_a$) varies with the volumetric strain in the air:
  \Beq
    K_a = \Deriv{\pbar_a}{\bar{\Veps_v^a}} = \gamma\,\pbar_r\,\exp(\gamma\,\bar{\Veps_v^a}) 
        = \gamma\,(\pbar_a + \pbar_r) \,.
  \Eeq

  \subsection{Bulk modulus model: Drained soil}
  The pressure model for drained soils has the form
  \Beq \label{eq:p_model_upd}
    \frac{\pbar^\Teff}{K_s(\pbar^\Teff)} = b_0\,\bar{\Veps_v^e} + 
        \frac{b_1 (\bar{\Veps_v^e})^{b_4}}{b_2 (\bar{\Veps_v^e})^{b_4} + b_3}
  \Eeq
  where the material parameters are $b_0 > 0, b_1 > 0, b_2 > 0, b_3 > 0, b_4 > 1$. 
  Dependence on plastic strain can be added to the model if necessary.  

  The tangent bulk modulus is defined as
  \Beq \label{eq:K_def}
    K_d(\pbar^\Teff) := \Deriv{\pbar^\Teff}{\bar{\Veps_v^e}} \,.
  \Eeq
  Then, using \eqref{eq:p_model_upd}, 
  \Beq \label{eq:K_first}
    K_d(\pbar^\Teff) = \frac{[K_s(\pbar^\Teff)]^2}{[K_s(\pbar^\Teff) - n_s \pbar^\Teff]}
      \left[b_0 + 
      \frac{b_1 b_3 b_4 (\bar{\Veps_v^e})^{b_4 - 1}}{\left[b_2 (\bar{\Veps_v^e})^{b_4} + b_3\right]^2}\right] \,.
  \Eeq
  To express \eqref{eq:K_first} in closed-form in terms of $\pbar$ we have to eliminate $\bar{\Veps}_v^e$.  
  But a closed form expression for the volumetric elastic strain cannot be derived from the pressure model.
  So we find an approximate form of \eqref{eq:p_model_upd} by assuming $b_0 \rightarrow 0$.  This 
  approximation is valid at moderate to large strains.  Then, from \eqref{eq:p_model_upd} with $b_0 = 0$, 
  we have
  \Beq
   \bar{\Veps_v^e} \approx \left[\frac{b_3 \pbar^\Teff}{b_1 K_s(\pbar^\Teff) - b_2 \pbar^\Teff}\right]^{1/b_4} 
  \Eeq
  and \eqref{eq:K_first} can be expressed in terms of $\pbar$ as
  \Beq \label{eq:K_dry}
    K_d(\pbar^\Teff) = \frac{[K_s(\pbar^\Teff)]^2}{[K_s(\pbar^\Teff) - n_s \pbar^\Teff]}
       \left[b_0 + 
         \frac{b_1 b_3 b_4 \left(\frac{b_3 \pbar^\Teff}{b_1 K_s(\pbar^\Teff) - b_2 \pbar^\Teff}\right)^{1 - 1/b_4}}{\left[b_2 \left(\frac{b_3 \pbar^\Teff}{b_1 K_s(\pbar^\Teff) - b_2 \pbar^\Teff}\right) + b_3\right]^2}\right] \,.
  \Eeq

  \subsection{Bulk modulus model: Partially saturated soil}
  The pressure in the partially saturated soil ($\pbar$) is given by
  \Beq
    \pbar = \int K(\bar{I}_1, \zetabar, \bar{\Veps_v^p}, \phi, S_w)~\text{d}\bar{\Veps}_v^e \,.
  \Eeq
  Note that
  \Beq
    \pbar^\Teff = \Third(\bar{I}_1 - \zetabar) \,.
  \Eeq
  The tangent bulk modulus of the partially saturated soil is found using a variation on
  the Grassman model for fully saturated rocks:
  \Beq
    K(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w) = 
     K_d(\pbar^\Teff) + \frac{\left(1 - \frac{K_d(\pbar^\Teff)}{K_s(\pbar^\Teff)}\right)^2}%
          {\frac{1}{K_s(\pbar^\Teff)}\left(1 - \frac{K_d(\pbar^\Teff)}{K_s(\pbar^\Teff)}\right) + 
             \phi \left(\frac{1}{K_f(\zetabar)} - \frac{1}{K_s(\pbar^\Teff)}\right)}
  \Eeq
  where $K$ is the effective bulk modulus of the partially saturated soil, 
  $K_d$ is the bulk modulus of the drained soil, $K_f$ is the bulk modulus of
  the pore fluid, and $K_s$ is the bulk modulus of the solid grains. At 
  partial saturation, we compute the pore fluid bulk modulus using a
  harmonic mean (lower bound) on the air and water bulk moduli ($K_a, K_f$):
  \Beq
    \frac{1}{K_f(\zetabar)} = \frac{S_w}{K_w(\zetabar)} + \frac{1-S_w}{K_a(\zetabar)} \,.
  \Eeq

  \subsection{Shear modulus model: Drained soil}
  The shear modulus is typically assumed to be constant.  However, a variable shear modulus may be
  needed to fit experimental data and to prevent negative values of Poisson's ratio in the simulations.
  In those situations a variable Poisson's ratio ($\nu$) is defined as
  \Beq
    \nu = \nu_1 + \nu_2\,\exp\left[-\frac{K_d(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w)}{K_s(\pbar^\Teff)}\right]
  \Eeq
  where $\nu_1$ and $\nu_2$ are material parameters.
  The shear modulus is computed using the Poisson's ratio and the drained bulk modulus:
  \Beq
    G(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w) = \frac{3 K_d(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w) (1 - 2\nu)}{2(1+\nu)} \,.
  \Eeq

\section{Rate-independent plasticity}

  \subsection{Yield function}
  The Arenisca yield function is
  \Beq
     f = \sqrt{J_2} - F_f(\Ionebar, \zeta) \, F_c(\Ionebar, \zetabar, \Xbar, \kappabar)
       = \sqrt{J_2} - F_f(\pbar^\Teff) \, F_c(\pbar^\Teff, \Xbar, \kappabar)
  \Eeq
  where 
  \Beq
    F_f(\pbar^\Teff)  = a_1 - a_3 \exp[- 3 a_2 \pbar^\Teff)] + 3 a_4 \pbar^\Teff 
  \Eeq
  and
  \Beq
    F_c(\pbar^\Teff, \Xbar, \kappabar)  = 
       \begin{cases}
         1 & \quad \text{for}\quad 3\pbar^\Teff \le \kappabar \\
         \sqrt{1 - \left(\cfrac{3\pbar^\Teff - \kappabar}{\Xbar - \kappabar}\right)^2} & 
           \quad \text{for}\quad 3\pbar^\Teff > \kappabar \,.
       \end{cases}
  \Eeq
  Here $\Xbar$ is the hydrostatic compressive strength, $\kappabar$ is the branch point at which the
  cap function $F_c$ starts decreasing until it reaches the hydrostatic strength point ($\Xbar, 0$),
  and
  \Beq
    J_2 = \Half \Bs:\Bs \,.
  \Eeq
  Non-associativity is modeled using a parameter $\beta$ that modifies $\sqrt{J_2}$ (see
  \ref{sec:nonhardening_return}).

  \subsection{Hydrostatic compressive strength:  Drained soil}
  The drained crush curve model is used to compute $\Xbar$ and has the form
  \Beq
    \bar{\Veps_v^p} - p_3 = \ln\left[1 - \frac{1 - \exp(-p_3)}{1 + 
           \left(\frac{\Xbar_d - p_0}{p_1}\right)^{p_2}}\right]  \,.
  \Eeq
  where $p_0$, $p_1$, $p_2$, $p_3$ are model parameters and $\bar{\xi} = \Xbar - \bar{p}_0$ where
  $\Xbar$ is the hydrostatic compressive strength.  The parameter $p_3$ is related to the initial
  porosity ($\phi_0$) by $p_3 = -\ln(1 - \phi_0)$.

  The drained hydrostatic compressive strength ($\Xbar_d/3$) is found from the drained material 
  crush curve using
  \Beq
    \Xbar_d(\bar{\Veps_v^p}, \phi_0) - p_0 = p_1\left[\frac{1 - \exp(-p_3)}%
                                            {1 - \exp(-p_3 + \bar{\Veps_v^p})} 
                                       - 1\right]^{1/p_2} ~,~~ p_3 := -\ln(1 - \phi_0) \,.
  \Eeq

  \subsection{Hydrostatic compressive strength: Partially saturated soil}
  The elastic part of the volumetric strain at yield is defined in the model as
  \Beq
    \Veps_v^{e,\text{yield}}(\bar{\Veps_v^p}) = \frac{\Xbar_d(\bar{\Veps_v^p}, \phi_0)}%
       {3\,K_d\left(\Half \frac{\Xbar_d(\bar{\Veps_v^p}, \phi_0)}{3} \right)}
  \Eeq
  where $X_d$ is found from the drained material crush curve.

  The elastic volumetric strain at yield is assumed to be identical for drained and
  partially saturated materials.  With this assumption, the compressive strength of 
  a partially saturated sand is given by
  \Beq
    \Xbar(\bar{\Veps_v^p}) = 
      3 K(\pbar^\Teff,\bar{\Veps_v^p}, \phi, S_w)\, \bar{\Veps}_v^{e,\text{yield}}(\bar{\Veps_v^p})
  \Eeq
  where $K$ is the bulk modulus of the partially saturated material.

  \subsection{Backstress: Pore pressure}
  The pore pressure as an isotropic backstress ($\zeta$) that translates the Cauchy stress to the 
  effective stress:
  \Beq
    \Bsig^\Teff = \Bsig - \zeta\BI ~,~~ \zeta := -[(1- S_w) \pbar_a + S_w \pbar_w] \,.
  \Eeq
  In the elastically unloaded state (where the effective stress is zero) we assume that the
  pore pressure ($\zetabar$) is related to the volumetric plastic strain by 
  \Beq \label{eq:expevp_phi_Sw}
    \exp(-\bar{\Veps_v^p}) = 
      \phi_0\,(1 - S_0) \exp\left[-\frac{1}{\gamma}\ln\left(\frac{\zetabar}{\pbar_r} + 1\right)\right] +
      \phi_0\,S_0\,\exp\left(-\frac{\zetabar - \pbar_0}{K_w}\right) +
      (1 - \phi_0)\exp\left(-\frac{\zetabar}{K_s}\right) \,.
  \Eeq 
  This equation can be solved for $\zetabar(\bar{\Veps_v^p})$ using a root finding algorithm.

  Alternatively, this equation can be converted into rate form and integrated using an explicit time stepping
  method if a Newton solve is too expensive or fails to converge:
  \Beq
    \zeta = \int \Deriv{\zeta}{\Veps_v^p}\,\text{d}\Veps_v^p \,.
  \Eeq
  where 
  \Beq
    \Deriv{\zeta}{\Veps_v^p} = \frac{\exp(-\bar{\Veps_v^p})}{\CalB} \,,
  \Eeq
  and
  \Beq
    \Bal
    \CalB := 
      \left[\frac{\phi_0\,(1 - S_0)}{\gamma(\pbar_r + \zetabar)}\right]
        \exp\left[-\frac{1}{\gamma}\ln\left(\frac{\zetabar}{\pbar_r} + 1\right)\right] +
      \frac{\phi_0\,S_0}{K_w}\exp\left(\frac{\pbar_0 - \zetabar}{K_w}\right) + 
      \frac{1-\phi_0}{K_s} \exp\left(-\frac{\zetabar}{K_s}\right) \,.
    \Eal
  \Eeq

\section{Rate-dependent plasticity}


\section{Porosity and saturation}
  The total volumetric strain is given by
  \Beq \label{eq:eps_v}
    \exp(\Veps_v) = (1 - S_0)\phi_0\exp(\Veps_v^a) + S_0\phi_0\exp(\Veps_v^w) 
          + (1 - \phi_0)\exp(\Veps_v^s) 
  \Eeq
  where $\phi_0, S_0$ are the initial porosity and saturation, and 
  \Beq \label{eq:eps_p_K}
    \Veps_v^w(\Veps_v) = -\frac{\pbar(\Veps_v) - \pbar_0}{K_w}  ~,~~
    \Veps_v^a(\Veps_v) = -\frac{1}{\gamma}\ln\left[1 + \frac{\pbar(\Veps_v)}{\pbar_r}\right] ~,~~
    \Veps_v^s(\Veps_v) = -\frac{\pbar(\Veps_v)}{K_s} \,.
  \Eeq
  We can combine \eqref{eq:eps_v} and \eqref{eq:eps_p_K} to solve for $\pbar(\Veps_v)$ and then
  compute the volumetric strain in the air in terms of the total volumetric strain.  

  \subsection{Saturation}
  The saturation function $S_w(\Veps_v)$, is given by
  \Beq
    S_w(\Veps_v) = \frac{\CalC(\Veps_v)}{1 + \CalC(\Veps_v)} ~,~~
    \CalC(\Veps_v) := \left(\frac{S_0}{1-S_0}\right)\exp(\Veps_v^w)\exp(-\Veps_v^a) \,.
  \Eeq
  
  \subsection{Porosity}
  The porosity evolution equation (in the elastically unloaded state) for partially saturated sand 
  has the form
  \Beq
    \phi(\Veps_v)
      = \phi_0\left(\frac{1 - S_0}{1 - S_w(\Veps_v)}\right)
         \left[\frac{\exp(\Veps_v^a)}{\exp(\Veps_v)}\right] \,.
  \Eeq

\section{Summary of partially saturated soil model}

  \begin{SummaryBox}[label=box:BulkModulusModel]{Bulk modulus model}
  {\bf Drained soil:}\\
  The equation of state of the drained soil is
  \[
    K_d = \frac{[K_s]^2}{[K_s - n_s \pbar^\Teff]}
      \left[b_0 + 
      \frac{b_1 b_3 b_4 (\bar{\Veps_v^e})^{b_4 - 1}}{\left[b_2 (\bar{\Veps_v^e})^{b_4} + b_3\right]^2}\right] 
    ~,\quad
   \bar{\Veps_v^e} \approx \left[\frac{b_3 \pbar^\Teff}{b_1 K_s - b_2 \pbar^\Teff}\right]^{1/b_4} \,.
  \]

  {\bf Partially saturated soil:}\\
  The bulk modulus model is
  \[
    K = K_d + \cfrac{\left(1 - \cfrac{K_d}{K_s}\right)^2}%
          {\cfrac{1}{K_s}\left(1 - \cfrac{K_d}{K_s}\right) + 
             \phi \left(\cfrac{S_w}{K_w} + \cfrac{1-S_w}{K_a} - \cfrac{1}{K_s}\right)}
  \]
  where
  \[
    K_s(\pbar) = K_{s0} + n_s\,(\pbar - \pbar_{s0}) ~,~~
    K_w(\pbar) = K_{w0} + n_w\,(\pbar - \pbar_{w0}) ~,~~
    K_a(\pbar) = \gamma\,(\pbar + \pbar_r) 
  \]
  \end{SummaryBox}

  \begin{SummaryBox}[label=box:ShearModulusModel]{Shear modulus model}
  The shear modulus is either a constant ($G_0$) or determined using a variable Poisson's ratio ($\nu$)
  \[
    \nu = \nu_1 + \nu_2\,\exp\left[-\frac{K_d(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w)}{K_s(\pbar^\Teff)}\right]
  \]
  \[
    G(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w) = \frac{3 K_d(\pbar^\Teff, \bar{\Veps_v^p}, \phi, S_w) (1 - 2\nu)}{2(1+\nu)} \,.
  \]
  \end{SummaryBox}

  \begin{SummaryBox}[label=box:YieldFunction]{Yield function}
  The Arenisca yield function is
  \Beq
     f = \sqrt{J_2} - F_f(\Ionebar, \zeta) \, F_c(\Ionebar, \zetabar, \Xbar, \kappabar)
       = \sqrt{J_2} - F_f(\pbar^\Teff) \, F_c(\pbar^\Teff, \Xbar, \kappabar)
  \Eeq
  where 
  \Beq
    F_f(\pbar^\Teff)  = a_1 - a_3 \exp[- 3 a_2 \pbar^\Teff)] + 3 a_4 \pbar^\Teff 
  \Eeq
  and
  \Beq
    F_c(\pbar^\Teff, \Xbar, \kappabar)  = 
       \begin{cases}
         1 & \quad \text{for}\quad 3\pbar^\Teff \le \kappabar \\
         \sqrt{1 - \left(\cfrac{3\pbar^\Teff - \kappabar}{\Xbar - \kappabar}\right)^2} & 
           \quad \text{for}\quad 3\pbar^\Teff > \kappabar \,.
       \end{cases}
  \Eeq
  Non-associativity is modeled using a parameter $\beta$ that modifies $\sqrt{J_2}$.
  \end{SummaryBox}

  \begin{SummaryBox}[label=box:HydroStrengthModel]{Hydrostatic strength model}
  {\bf Drained soil:}
  \[
    \Xbar_d(\bar{\Veps_v^p}) - p_0 = p_1\left[\frac{1 - \exp(-p_3)}%
                                            {1 - \exp(-p_3 + \bar{\Veps_v^p})} 
                                       - 1\right]^{1/p_2} \qquad, \quad p_3 = -\ln(1 - \phi_0) \,.
  \]
  {\bf Partially saturated soil:}
  \[
    \Xbar(\bar{\Veps_v^p}) = 
      3 K(\bar{I}_1,\bar{\Veps_v^p}, \phi, S_w)\, \bar{\Veps}_v^{e,\text{yield}}(\bar{\Veps_v^p})
  \]
  where
  \[
    \Veps_v^{e,\text{yield}}(\bar{\Veps_v^p}) = \cfrac{\Xbar_d(\bar{\Veps_v^p})}%
       {3\,K_d\left(\cfrac{\Xbar_d(\bar{\Veps_v^p})}{6}, \bar{\Veps_v^p}\right)}
  \]
  \end{SummaryBox}
  
  \begin{SummaryBox}[label=box:PorePressureModel]{Pore pressure model}
  Solve $g(\zetabar, \bar{\Veps_v^p}) = 0$ for $\zetabar$.
  \[
    g(\zetabar, \bar{\Veps_v^p}) = 
    -\exp(-\bar{\Veps_v^p}) + 
      \phi_0\,(1 - S_0) \exp\left[-\frac{1}{\gamma}\ln\left(\frac{\zetabar}{\pbar_r} + 1\right)\right] +
      \phi_0\,S_0\,\exp\left(-\frac{\zetabar - \pbar_0}{K_w}\right) +
      (1 - \phi_0)\exp\left(-\frac{\zetabar}{K_s}\right) \,.
  \]
  Alternatively, integrate
  \[
    \zetabar = \int \Deriv{\zetabar}{\bar{\Veps_v^p}}\,\text{d}\bar{\Veps_v^p} \,.
  \]
  where 
  \[
    \Deriv{\zetabar}{\bar{\Veps_v^p}} = \frac{\exp(-\bar{\Veps_v^p})}{\CalB} \,,
  \]
  and
  \[
    \Bal
    \CalB := 
      \left[\frac{\phi_0\,(1 - S_0)}{\gamma(\pbar_r + \zetabar)}\right]
        \exp\left[-\frac{1}{\gamma}\ln\left(\frac{\zetabar}{\pbar_r} + 1\right)\right] +
      \frac{\phi_0\,S_0}{K_w}\exp\left(\frac{\pbar_0 - \zetabar}{K_w}\right) + 
      \frac{1-\phi_0}{K_s} \exp\left(-\frac{\zetabar}{K_s}\right) \,.
    \Eal
  \]
  \end{SummaryBox}

  \begin{SummaryBox}[label=box:Saturation]{Saturation and porosity evolution}
  {\bf Saturation}:
  \[
    S_w(\Veps_v) = \frac{\CalC(\Veps_v)}{1 + \CalC(\Veps_v)} ~,~~
    \CalC(\Veps_v) := \left(\frac{S_0}{1-S_0}\right)\exp(\Veps_v^w)\exp(-\Veps_v^a) \,.
  \]
  where
  $\phi_0, S_0$ are the initial porosity and saturation, and 
  \[
    \Veps_v^w(\Veps_v) = -\frac{\pbar(\Veps_v) - \pbar_0}{K_w}  ~,~~
    \Veps_v^a(\Veps_v) = -\frac{1}{\gamma}\ln\left[1 + \frac{\pbar(\Veps_v)}{\pbar_r}\right] ~,~~
    \Veps_v^s(\Veps_v) = -\frac{\pbar(\Veps_v)}{K_s} \,.
  \]
  {\bf Porosity}:
  \Beq
    \phi(\Veps_v)
      = \phi_0\left(\frac{1 - S_0}{1 - S_w(\Veps_v)}\right)
         \left[\frac{\exp(\Veps_v^a)}{\exp(\Veps_v)}\right] \,.
  \Eeq
  Note that
  \[
    \exp(\Veps_v) = (1 - S_0)\phi_0\exp(\Veps_v^a) + S_0\phi_0\exp(\Veps_v^w) 
          + (1 - \phi_0)\exp(\Veps_v^s) 
  \]
  \end{SummaryBox}


\section{Computing the stress and internal variables}
The partially saturated soil model uses Michael Homel's ``consistency bisection'' algorithm 
to find the plastic strain direction and to update the internal state variables.  A closest-point
return algorithm in transformed stress space is used to project the trial stress state on to the
yield surface. 
Because of the nonlinearities in the material models, it is easier to solve the problem by 
dividing the strain increment to substeps.

The partially saturated soil model treats the porosity ($\phi$) and saturation ($S_w$) as internal 
variables in addition to the hydrostatic compressive strength ($X$), the isotropic backstress ($\zeta$), 
and the plastic strain ($\Bveps^\Tp$) which are used by the fully saturated model.

The inputs to the rate-independent stress update algorithm for a single material point are:
\begin{itemize}
  \item $\Bd^{\Tn}$ : {\Ochre the rate of deformation at time $t = t_n$; 
        defined as $\Bd := \Half(\BlT + \BlT^T)$ where 
        $\BlT = \Grad{\Bv}$ and $\Bv$ is the velocity field.}
  \item $\Delta t$ : {\Ochre the time step}
  \item $\Bsig^\Tn$ : {\Ochre the unrotated Cauchy step at time $t = t_n$.}
  \item $\phi^\Tn$ : {\Ochre the porosity at time $t = t_n$.}
  \item $S_w^\Tn$ : {\Ochre the saturation at time $t = t_n$.}
  \item $X^\Tn$ : {\Ochre the hydrostatic compressive strength at time $t = t_n$.}
  \item $\zeta^\Tn$ : {\Ochre the trace of the backstress at time $t = t_n$.}
  \item $\Bveps^{\Tp,\Tn}$ : {\Ochre the plastic strain at time $t = t_n$.}
\end{itemize}
After the return algorithm has been exercised, the outputs from the algorithm are:
\begin{itemize}
  \item $\Bsig^{\Tn+1}$ : {\Ochre the unrotated Cauchy step at time $t = t_{n+1} = t_n + \Delta t$.}
  \item $\phi^{\Tn+1}$ : {\Ochre the porosity at time $t = t_{n+1}$.}
  \item $S_w^{\Tn+1}$ : {\Ochre the saturation at time $t = t_{n+1}$.}
  \item $X^{\Tn+1}$ : {\Ochre the hydrostatic compressive strength at time $t = t_{n+1}$.}
  \item $\zeta^{\Tn+1}$ : {\Ochre the trace of the backstress at time $t = t_{n+1}$.}
  \item $\Bveps^{\Tp,\Tn+1}$ : {\Ochre the plastic strain at time $t = t_{n+1}$.}
\end{itemize}

The update algorithm uses the standard predictor-corrector approach of hypoelastic-plasticity
where a trial predictor stress is computed first and then a corrector return algorithm is used to
locate the position of the correct stress on the yield surface. This approach requires that
the trial stress ($\Bsig^\Trial$) is computed using the relation
\Beq
  \Bsig^\Trial = \Bsig^\Tn + \SfC^\Te:(\Bd\,\Delta t)
\Eeq
where $\SfC^\Te$ is an elastic modulus that is typically assumed to be constant over the time 
step $\Delta t$.  Though this assumption suffices for nonlinear elastic materials if the rate of 
deformation is small or the timestep is small or both, for large $\Bd \Delta t$ significant errors
can enter the calculation.  {\Ochre The Vaango implementation assumes that $\SfC^e$ is the tangent 
modulus at the beginning of a timestep (or load substep).}

\paragraph{Caveat:}
The partially saturated soil model has been developed for an explicit dynamics code where 
tiemsteps are typically very small.  Care should be exercised if the application domain
requires timesteps to be large.

\paragraph{Remark:}
{\footnotesize
Note that in the Kayenta model (which is the basis for Arenisca), the bulk modulus has a high pressure 
limit.  This limit was used by Michael Homel in Arenisca3 and Arenisca4 to define conservative elastic
properties during the stress and internal variable update.  However, the bulk modulus model used 
by the partially saturated version of Arenisca does not have this limit.  Therefore the trial stress
for the partially saturated model is computed using an alternative approach that assumes that
the elastic moduli are those at the beginning of the timestep (or load substep).
}

After the trial stress is computed, the timestep is subdivided into substeps based on the 
characteristic dimension of the yield surface relative to the magnitude of the trial stress 
increment ($\Bsig^\Trial - \Bsig^\Tn$).  The substep size is then recomputed by comparing the
elastic properties at $\Bsig^\Trial$ with those at $\Bsig^\Tn$ to make sure that the nonlinear
elastic solution is accurate.
 
The pseudocode for the algorithm is given below.
\begin{breakablealgorithm}
  \caption{The stress and internal variable update algorithm}
  \begin{algorithmic}[1]
    \Procedure{updateStressAndInternalVars}{$\Bd^\Tn$, $\Delta t$, $\Bsig^\Tn$, 
                                            $\phi^\Tn$, $S_w^\Tn$, $X^\Tn$, $\zeta^\Tn$,
                                            $\Bveps^{\Tp,\Tn}$} 
      \State $K^\Tn, G^\Tn \leftarrow$ \textsc{computeElasticModuli}($\Bsig^\Tn$, $\Bveps^{\Tp,\Tn}$,
                                                                 $\phi^\Tn$, $S_w^\Tn$)
        \Comment{Compute tangent bulk and shear modulus}
      \State $\Bsig^\Trial \leftarrow$ \textsc{computeTrialStress}($\Bsig^\Tn$, $K^\Tn$, $G^\Tn$,
                                                                  $\Bd^\Tn$, $\Delta t$)
        \Comment{Compute trial stress}
      \State $n_\Tsub \leftarrow $ \textsc{computeStepDivisions}($\Bsig^\Tn$, $\Bveps^{\Tp,\Tn}$,
                                                                $\phi^\Tn$, $S_w^\Tn$,
                                                                $\Bsig^\Trial$)
        \Comment{Compute number of substeps}
      \State $\delta t \leftarrow \cfrac{\Delta t}{n_\Tsub}$
        \Comment{Substep timestep}
      \State $\Bsig^\Told \leftarrow \Bsig^\Tn$, $\Bveps^{\Tp,\Told} \leftarrow \Bveps^{\Tp,\Tn}$,
             $\phi^\Told \leftarrow \phi^\Tn$, $S_w^\Told \leftarrow S_w^\Tn$,
             $X^\Told \leftarrow X^\Tn$, $\zeta^\Told \leftarrow \zeta^\Tn$ 
      \State $\chi \leftarrow 1$, $t_\Tlocal \leftarrow 0.0$
        \Comment{Initialize substep multiplier and accumulated time increment}
      \State isSuccess $\leftarrow$ FALSE
      \Repeat
        \State isSuccess, $\Bsig^\Tnew$, $\Bveps^{\Tp,\Tnew}$, $\phi^\Tnew$, $S_w^\Tnew$, $X^\Tnew$, $\zeta^\Tnew \leftarrow$
          \textsc{computeSubstep}($\Bsig^\Told$, $\Bveps^{\Tp,\Told}$, $\phi^\Told$, $S_w^\Told$, 
                                  $X^\Told$, $\zeta^\Told$, $\Bd^\Tn$, $\delta t$)
          \Comment{Compute updated stress and internal variable for the current substep}
        
        \If {isSuccess = TRUE}
           \State $ t_\Tlocal \leftarrow t_\Tlocal + \delta t$
           \State $\Bsig^\Told \leftarrow \Bsig^\Tnew$, $\Bveps^{\Tp,\Told} \leftarrow \Bveps^{\Tp,\Tnew}$,
                  $\phi^\Told \leftarrow \phi^\Tnew$, $S_w^\Told \leftarrow S_w^\Tnew$ 
                  $X^\Told \leftarrow X^\Tnew$, $\zeta^\Told \leftarrow \zeta^\Tnew$ 
        \Else
           \State $\chi \leftarrow 2\chi$
           \State $\delta t \leftarrow \delta t/2$
             \Comment {Halve the timestep}
           \If {$\chi > \text{CHI\_MAX}$}
             \State \Return IsSuccess, $\Bsig^\Tn$, $\phi^\Tn$, $S_w^\Tn$, $X^\Tn$, $\zeta^\Tn$,
                                            $\Bveps^{\Tp,\Tn}$ 
               \Comment {Algorithm has failed to converge}
           \EndIf
        \EndIf
      \Until {$t_\Tlocal \ge \Delta t$}
      \State \Return IsSuccess, $\Bsig^\Tnew$, $\phi^\Tnew$, $S_w^\Tnew$, $X^\Tnew$, $\zeta^\Tnew$,
                                            $\Bveps^{\Tp,\Tnew}$ 
        \Comment {Algorithm has converged}
      
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
  \caption{Computing the elastic moduli}
  \begin{algorithmic}[1]
    \Procedure{computeElasticModuli}{$\Bsig^\Tn$, $\Bveps^{\Tp,\Tn}$, $\phi^\Tn$, $S_w^\Tn$}
      \State $K \leftarrow 0$, $G \leftarrow 0$
      \State $\Ionebar \leftarrow -\Tr(\Bsig^\Tn)$, 
             $\bar{\Veps^\Tp_v} \leftarrow -\Tr(\Bveps^{\Tp,\Tn})$
      \If {$S_w^\Tn > 0$}
        \State $K, G \leftarrow$ \textsc{computePartialSaturatedModuli}($\Ionebar$, $\bar{\Veps^\Tp_v}$,
                                                                        $\phi^\Tn$, $S_w^\Tn$)
      \Else
        \State $K, G \leftarrow$ \textsc{computeDrainedModuli}($\Ionebar$, $\bar{\Veps^\Tp_v}$)
      \EndIf
      \State \Return $K, G$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
  \caption{Computing the partially saturated elastic moduli}
  \begin{algorithmic}[1]
    \Require $K_{s0}$, $n_s$, $\pbar_{s0}$, $K_{w0}$, $n_w$, $\pbar_{w0}$, $\gamma$, $\pbar_r$
    \Procedure{computePartialSaturatedModuli}{$\Ionebar$, $\bar{\Veps^\Tp_v}$, $\phi^\Tn$, $S_w^\Tn$}
      \If {$\Ionebar > 0$}
        \State $\pbar \leftarrow \Ionebar/3$
        \State $K_s \leftarrow K_{s0} + n_s (\pbar - \pbar_{s0})$
        \State $K_w \leftarrow K_{w0} + n_w (\pbar - \pbar_{w0})$
        \State $K_a \leftarrow \gamma (\pbar + \pbar_r)$
        \State $K_d, G \leftarrow$ \textsc{computeDrainedModuli}($\Ionebar$, $\bar{\Veps^\Tp_v}$)
        \State $K_f \leftarrow 1.0/\left[S_w^\Tn/K_w + (1.0-S_w^\Tn)/K_a\right]$
          \Comment{Bulk modulus of air + water mixture}
        \State $\text{numer} \leftarrow (1.0 - K_d/K_s)^2$
        \State $\text{denom} \leftarrow (1.0/K_s)\,(1.0 - K_d/K_s) + \phi^\Tn\,(1.0/K_f - 1.0/K_s)$
        \State $K \leftarrow K_d + \text{numer}/\text{denom}$
          \Comment{Bulk modulus of partially saturated material (Biot-Grassman model)}
      \Else
        \State $K, G \leftarrow$ \textsc{computeDrainedModuli}($\Ionebar$, $\bar{\Veps^\Tp_v}$)
      \EndIf
      \State \Return $K, G$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
  \caption{Computing the drained elastic moduli}
  \begin{algorithmic}[1]
    \Require $K_{s0}$, $n_s$, $\pbar_{s0}$, $b_0$, $b_1$, $b_2$, $b_3$, $b_4$, $G_0$, $\nu_1$, $\nu_2$
    \Procedure{computeDrainedModuli}{$\Ionebar$, $\bar{\Veps^\Tp_v}$}
      \If {$\Ionebar > 0$}
        \State $\pbar \leftarrow \Ionebar/3$
        \State $K_s \leftarrow K_{s0} + n_s (\pbar - \pbar_{s0})$
        \State $K_s^\Tratio \leftarrow K_s/(1.0 - n_s*\pbar/K_s)$
        \State $\Veps^\Te_v \leftarrow$ \textsc{pow}($(b_3*\pbar)/(b_1K_s - b_2\pbar)$, $(1.0/b_4)$);
        \State $y \leftarrow $ \textsc{pow}($\Veps^\Te_v$, $b_4$)
        \State $z \leftarrow b_2y + b_3$
        \State $K \leftarrow K_s^\Tratio[b_0 + (1/\Veps^\Te_v)b_1b_3b_4y/z^2]$;
          \Comment{ Compute compressive bulk modulus}
        \State $\nu = \nu_1 + \nu_2\exp(-K/K_s)$
        \State $ G \leftarrow G_0$
        \If {$\nu > 0$}
          \State $G \leftarrow 1.5K\,(1.0-2.0\nu)/(1.0+\nu)$
            \Comment{Update the shear modulus (if $nu_1, \nu_2 > 0$)}
        \EndIf
      \Else
        \State $K \leftarrow b_0K_{s0}$
          \Comment{Tensile bulk modulus = Bulk modulus at p = 0}
        \State $G \leftarrow G_0$
          \Comment{Tensile shear modulus}
      \EndIf
      \State \Return $K, G$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
  \caption{Computing the trial stress}
  \begin{algorithmic}[1]
    \Procedure{computeTrialStress}{$\Bsig^\Tn$, $K^\Tn$, $G^\Tn$, $\Bd^\Tn$, $\Delta t$}
      \State $\Delta\Bveps \leftarrow \Bd^\Tn\,\Delta t$
        \Comment{Total strain increment}
      \State $\Delta\Bveps^\Tiso \leftarrow \Third \Tr(\Delta\Bveps) \BI$
      \State $\Delta\Bveps^\Tdev \leftarrow \Delta\Bveps - \Delta\Bveps^\Tiso$
      \State $\Bsig^\Trial \leftarrow \Bsig^\Tn + 3 K^\Tn \Delta\Bveps^\Tiso 
               + 2 G^\Tn \Delta\Bveps^\Tdev$ 
      \State \Return $\Bsig^\Trial$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
  \caption{Computing the initial number of substeps}
  \begin{algorithmic}[1]
    \Require $n^\Tmax$ , $I_1^\Tpeak$, STREN, $\epsilon \leftarrow 10^{-4}$
    \Procedure{computeStepDivisions}{$\Bsig^\Tn$, $\Bveps^{\Tp,\Tn}$, $\phi^\Tn$, $S_w^\Tn$, $\Bsig^\Trial$, $X^\Tn$}
      \State $K^\Tn, G^\Tn \leftarrow$ \textsc{computeElasticModuli}($\Bsig^\Tn$, $\Bveps^{\Tp,\Tn}$, $\phi^\Tn$, $S_w^\Tn$)
      \State $K^\Trial, G^\Trial \leftarrow$ \textsc{computeElasticModuli}($\Bsig^\Trial$, $\Bveps^{\Tp,\Tn}$, $\phi^\Tn$, $S_w^\Tn$)
      \State $n^\text{bulk} \leftarrow \lceil\left|K^\Tn - K^\Trial\right|/K^\Tn\rceil$  
        \Comment {Compute change in bulk modulus}
      \State $\Delta\Bsig \leftarrow \Bsig^\Trial - \Bsig^\Tn$
      \State $L \leftarrow \Half(I_1^\Tpeak - X^\Tn)$
      \If {STREN $> 0.0$}
        \State $L \leftarrow $ \textsc{min}($L$, STREN)
      \EndIf
      \State $n^{\text{yield}} \leftarrow \lceil\epsilon \times \Norm{\Delta\Bsig}{}/L\rceil$
        \Comment{Compute trial stress increment relative to yield surface size}
      \State $n^\Tsub \leftarrow$ \textsc{max}($n^\text{bulk}$, $n^\text{yield}$)
        \Comment{$n^\Tsub$ is the maximum of the two values}
      \If {$n^\Tsub > n^\Tmax$}
        \State $n^\Tsub \leftarrow -1$
      \Else
        \State $n^\Tsub \leftarrow$  \textsc{min}(\textsc{max}($n^\Tsub$, 1), $n^\Tmax$)
      \EndIf
      \State \Return $n^\Tsub$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
  \caption{Computing the stress and internal variable update for a substep}
  \begin{algorithmic}[1]
    \Procedure{computeSubstep}{$\Bsig^\Told$, $\Bveps^{\Tp,\Told}$, $\phi^\Told$, $S_w^\Told$, 
                               $X^\Told$, $\zeta^\Told$, $\Bd^\Tn$, $\delta t$}
      \State $K^\Told, G^\Told \leftarrow$ \textsc{computeElasticModuli}($\Bsig^\Told$, $\Bveps^{\Tp,\Told}$,
                                                                 $\phi^\Told$, $S_w^\Told$)
        \Comment{Compute tangent bulk and shear modulus}
      \State $\delta \Bveps \leftarrow \Bd^\Tn \delta t$
        \Comment{Compute strain increment}
      \State $\Bsig^\Trial \leftarrow$ \textsc{computeTrialStress}($\Bsig^\Told$, $K^\Told$, $G^\Told$,
                                                                  $\Bd^\Tn$, $\Delta t$)
        \Comment{Compute trial stress}
      \State $I_1^{\Trial}$, $\sqrt{J_2^{\Trial}} \leftarrow$ \textsc{stressInvariants}($\Bsig^\Trial$)
        \Comment{Compute invariants of the trial stress}
      \State isElastic $\leftarrow$ \textsc{evalYieldCondition}($I_1^\Trial$, $\sqrt{J_2^\Trial}$, $X^\Told$, 
                                                                $\zeta^\Told$, $K^\Told$, $G^\Told$, $\beta$)
      \If {isElastic = TRUE}
        \State $\Bsig^\Tnew \leftarrow \Bsig^\Trial$,
               $\Bveps^{\Tp,\Tnew} \leftarrow \Bveps^{\Tp,\Told}$,
               $\phi^\Tnew \leftarrow \phi^\Told$,
               $S_w^\Tnew \leftarrow S_w^\Told$,
               $X^\Tnew \leftarrow X^\Told$,
               $\zeta^\Tnew \leftarrow \zeta^\Told$
        \State isSuccess = TRUE
        \State \Return isSuccess, $\Bsig^\Tnew$, $\Bveps^{\Tp,\Tnew}$ $\phi^\Tnew$, $S_w^\Tnew$, $X^\Tnew$,
               $\zeta^\Tnew$
      \EndIf

      \State $\Bsig^0$, $\delta\Bveps^{\Tp,0}$ $\leftarrow$
        \textsc{nonHardeningReturn}($\Bsig^\Told$, $\Bsig^\Trial$, $\delta\Bveps$,
                                     $X^\Told$, $\zeta^\Told$, $K^\Told$, $G^\Told$, $\beta$, $I_1^\Tpeak$)
        \Comment{Compute return to updated yield surface (no hardening)}
      \State isSuccess, $\Bsig^\Tnew$, $\Bveps^{\Tp,\Tnew}$, $X^\Tnew$, $\zeta^\Tnew$, $K^\Tmid$, $G^\Tmid$
        $\leftarrow$ \textsc{consistencyBisection}($\Bveps^{\Tp,\Told}$, $\delta\Bveps^{\Tp,0}$, $\zeta^\Told$,
                                     $\Bsig^0$, $\Bsig^\Trial$, $K^\Told$, $G^\Told$, $\beta$, $I_1^\Tpeak$)
      \If {iSuccess = FALSE}
        \State \Return isSuccess, $\Bsig^\Told$, $\Bveps^{\Tp,\Told}$, $\phi^\Told$, $S_w^\Told$, $X^\Told$, 
          $\zeta^\Told$
      \EndIf
      \State \Return isSuccess, $\Bsig^\Tnew$, $\Bveps^{\Tp,\Tnew}$, $\phi^\Tnew$, $S_w^\Tnew$, $X^\Tnew$, 
          $\zeta^\Tnew$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}

\section{The consistency bisection algorithm}
\subsection{Fixed (nonhardening) yield surface}
Let the stress at the beginning of the load step be $\Bsig^\Told$ and let the trial stress be 
$\Bsig^\Trial$.  Assume the yield surface is fixed and let the correct projection of the trial 
stress on to the fixed yield surface be $\Bsig^{\Tnew, 0}$.

The increment of stress for the load step ($\Delta\Bsig^0$) is related to the 
elastic strain increment ($\Delta\Bveps^{\Te,0}) $by
\Beq
  \Delta\Bsig^0 = \Bsig^{\Tnew,0} - \Bsig^\Told = \SfC:\Delta\Bveps^{\Te,0}
\Eeq
where $\SfC$ is a constant elastic modulus tensor.  The elastic modulus tensor can be assumed
to be an average value of the nonlinear tangent modulus for the load step.

If we know $\SfC$, we can compute the elastic strain increment using
\Beq
  \Delta\Bveps^{\Te,0} = \SfC^{-1}:\Delta\Bsig^0 \,.
\Eeq

For a strain driven update algorithm, the total strain increment $\Delta\Bveps$ is known.
Assuming that the total strain increment can be additively decomposed into an elastic and a 
plastic part, we can find the plastic strain increment ($\Delta\Bveps^{\Tp,0}$) using
\Beq
  \Delta\Bveps^{\Tp,0} = \Delta\Bveps - \Delta\Bveps^{\Te,0} \,.
\Eeq

\subsection{Hardening yield surface}
Now, if we allow the yield surface to harden, the distance between the trial stress point and its 
projection on to the yield surface decreases compared to that for a fixed yield surface.  If
$\Delta\Bveps^\Tp$ is the plastic strain increment for a hardening yield surface, we have
\Beq
  \Delta\Bveps^\Tp > \Delta\Bveps^{\Tp,0}   
\Eeq
where the inequality can be evaluated using an appropriate Euclidean norm.
Note that this distance is proportional to the consistency parameter $\dot{\lambda}$.

\subsubsection{Fully saturated model}
In the fully saturated version of the Arenisca model, the internal variables are the hydrostatic
compressive strength ($X$) and the scalar isotropic backstress ($\zeta$).  These depend only on the
{\bf volumetric} plastic strain increment 
\Beq
  \Delta\Veps^\Tp_v = \Tr(\Delta\Bveps^\Tp) \,.
\Eeq
Because
\Beq
  \Delta\Veps^\Tp_v > \Delta\Veps^{\Tp,0}_v   
\Eeq
we can define a parameter, $\eta \in (0, 1)$, such that
\Beq
  \eta := \cfrac{\Delta\Veps^\Tp_v}{\Delta\Veps^{\Tp,0}_v} \,.
\Eeq
Because the solution is bounded by the fixed yield surface, a bisection algorithm can be used
to find the parameter $\eta$.

\subsubsection{Partially saturated model}
{\Red TODO}

\subsection{Bisection algorithm: Fully saturated}
\begin{breakablealgorithm}
  \caption{The consistency bisection algorithm for fully saturated materials}
  \begin{algorithmic}[1]
    \Procedure{consistencyBisection}{$\Bveps^{\Tp,\Told}$, $\delta\Bveps^{\Tp,0}$, $\zeta^\Told$,
                                     $\Bsig^0$, $\Bsig^\Trial$, 
                                     $K^\Told$, $G^\Told$, $\beta$, $I_1^\Tpeak$}
      \State $\Bsig^\Tnew \leftarrow \Bsig^0$, $\delta\Bveps^\Tp \leftarrow \delta\Bveps^{\Tp,0}$
      \State $\Veps^{\Tp,\Told}_v \leftarrow \Tr(\Bveps^{\Tp,\Told})$, 
             $\delta\Veps^{\Tp,\Told}_v \leftarrow \Tr(\delta\Bveps^{\Tp,\Told})$
      \State $i \leftarrow 1$
      \State $\eta^\Tin \leftarrow 0$,  $\eta^\Tout \leftarrow 1$ 
      \Repeat
        \State $j \leftarrow 1$
        \State isElastic $\leftarrow$ TRUE
        \While {isElastic = TRUE}
          \State $\eta^\Tmid \leftarrow \Half(\eta^\Tout + \eta^\Tin)$
          \State $X^\Tnew \leftarrow$ \textsc{computeHydrostaticStrength}($\Veps^{\Tp,\Told}_v + 
                                          \eta^\Tmid \,\delta\Veps^{\Tp,0}_v$)
            \Comment {Update the hydrostatic compressive strength}
          \State $\Partial{\zeta}{\Veps^{\Tp}_v} \leftarrow $
            \textsc{computeDerivativeOfBackstress}({\Red Arguments?})
          \State $\zeta^\Tnew \leftarrow \zeta^\Told + 
            \left(\Partial{\zeta}{\Veps^{\Tp}_v}\right)\times(\eta^\Tmid \,\delta\Veps^{\Tp,0}_v)$
            \Comment {Update the isotropic backstress}
          \State $I_1^{\Trial}$, $\sqrt{J_2^{\Trial}} \leftarrow$ \textsc{stressInvariants}($\Bsig^\Trial$)
            \Comment{Compute invariants of the trial stress}
          \State isElastic $\leftarrow$ \textsc{evalYieldCondition}($I_1^\Trial$, $\sqrt{J_2^\Trial}$, $X^\Tnew$, 
                                                                    $\zeta^\Tnew$, $K^\Told$, $G^\Told$,
                                                                    $\beta$)
          \State $\eta^\Tout \leftarrow \eta^\Tmid$ 
            \Comment{Too much plastic strain}
          \State $j \leftarrow j+1$
          \If {$j \ge j^\Tmax$}
             \State isSuccess $\leftarrow$ FALSE
             \State \Return isSuccess 
          \EndIf
        \EndWhile
        \State $\Bsig^\Tmid \leftarrow \Half(\Bsig^\Told + \Bsig^\Tnew)$
        \State $\Bveps^{\Tp,\Tmid} \leftarrow \Bveps^{\Tp,\Told} + \Half \eta^\Tmid \,\delta\Bveps^{\Tp,0}$
        \State $K^\Tmid, G^\Tmid \leftarrow$ 
           \textsc{computeElasticModuli}($\Bsig^\Tmid$, $\Bveps^{\Tp,\Tmid}$)
        \State $\Bsig^\Tnew$, $\delta\Bveps^{\Tp,\Tnew}$ $\leftarrow$
          \textsc{nonHardeningReturn}($\Bsig^\Told$, $\Bsig^\Trial$, $\delta\Bveps^\Tnew$,
                                     $X^\Tnew$, $\zeta^\Tnew$, $K^\Tmid$, $G^\Tmid$, $\beta$, $I_1^\Tpeak$)
          \Comment{Compute return to updated yield surface (no hardening)}
        \If {sign($\Tr(\Bsig^\Trial - \Bsig^\Tnew)$) $\ne$ sign($\Tr(\Bsig^\Trial - \Bsig^0)$)
             \textbf{or} $\Norm{\delta\Bveps^{\Tp,\Tnew}}{2} > 
               \eta^\Tmid \Norm{\delta\Bveps^{\Tp,0}}{2}$}
          \State $\eta^\Tout \leftarrow \eta^\Tmid$ 
            \Comment{Too much plastic strain}
        \Else
          \If {$\Norm{\delta\Bveps^{\Tp,\Tnew}}{2} < \eta^\Tmid \Norm{\delta\Bveps^{\Tp,0}}{2}$}
            \State $\eta^\Tin \leftarrow \eta^\Tmid$ 
              \Comment{Too little plastic strain}
          \EndIf
        \EndIf
        \State $i \leftarrow i+1$
        \If {$i \ge i^\Tmax$}
          \State isSuccess $\leftarrow$ FALSE
          \State \Return isSuccess 
        \EndIf
      \Until {abs($\Norm{\delta\Bveps^{\Tp,\Tnew}}{2} - \eta^\Tmid \Norm{\delta\Bveps^{\Tp,0}}{2}) < $ TOLERANCE}
      \State $\Bveps^{\Tp,\Tnew} = \Bveps^{\Tp,\Told} + \delta\Bveps^{\Tp,\Tnew}$
        \Comment{Update the plastic strain}
      \State $X^\Tnew \leftarrow$ \textsc{computeHydrostaticStrength}($\Tr(\Bveps^{\Tp,\Tnew})$)
        \Comment {Update the hydrostatic compressive strength}
      \State $\Partial{\zeta}{\Veps^{\Tp}_v} \leftarrow $
        \textsc{computeDerivativeOfBackstress}({\Red Arguments?})
      \State $\zeta^\Tnew \leftarrow \zeta^\Told + 
        \left(\Partial{\zeta}{\Veps^{\Tp}_v}\right)\times(\Tr(\delta\Bveps^{\Tp,\Tnew}))$
        \Comment {Update the isotropic backstress}
      \State isSuccess $\leftarrow$ TRUE
      \State \Return isSuccess, $\Bsig^\Tnew$,
                     $\Bveps^{\Tp,\Tnew}$, $X^\Tnew$, $\zeta^\Tnew$, $K^\Tmid$, $G^\Tmid$
    \EndProcedure
  \end{algorithmic}
\end{breakablealgorithm}


\section{The nonhardening return algorithm}
\label{sec:nonhardening_return}
Let the plastic flow direction be $\BM$.  Then
\Beq
  \dot{\Bveps^p} = \dot{\lambda}\BM \,.
\Eeq
The nonhardening return algorithm uses a transformed space where the computation is carried out
in special Lode coordinates ($z', r'$) where
\Beq
  z' = z - \cfrac{\zeta}{\sqrt{3}} ~,~~ z := \cfrac{I_1}{\sqrt{3}} \quad \Tand \quad
  r' = \sqrt{\cfrac{3K}{2G}}\,r ~,~~ r := \sqrt{2J_2} \,.
\Eeq
If the flow rule is non-associative, the yield surface parameter $\beta \ne 1$.  In that case,
\Beq
  r' \leftarrow \beta r' \,.
\Eeq

The quantities needed by the non-hardening return algorithm are:
\begin{algorithmic}[1]
  \Require as input
    \begin{itemize} 
      \item $\Bsig^\Trial$ \Comment{Trial stress} 
      \item $\Bsig^\Told$  \Comment{Stress at the start of the substep}
      \item $\delta\Bveps^\Tnew$  \Comment{Increment of total strain}
      \item $X^\Told$ \Comment{Hydrostatic compressive strength}      
      \item $\zeta^\Told$ \Comment{Isotropic backstress (trace)}      
      \item $K^\Told$ \Comment{Tangent bulk modulus}      
      \item $G^\Told$ \Comment{Tangent shear modulus}      
      \item $I_1^\Tpeak$ \Comment{The location of the yield surface vertex}
      \item $\beta$ \Comment{The yield surface non-associativity parameter}
    \end{itemize}
\end{algorithmic}

The nonhardening return algorithm pseudocode is listed below:
\begin{breakablealgorithm}
\caption{Non-hardening return algorithm}
\begin{algorithmic}[1]
  \Procedure{nonHardeningReturn}{$\Bsig^\Told$, $\Bsig^\Trial$, $\delta\Bveps^\Tnew$,
                                 $X^\Told$, $\zeta^\Told$, $K^\Told$, $G^\Told$, $\beta$, $I_1^\Tpeak$}
  \State $I_1^{\Trial}$, $J_2^{\Trial} \leftarrow$ \textsc{stressInvariants}($\Bsig^\Trial$)
         \Comment{Compute invariants of the trial stress}
  \State $r^\Trial \leftarrow \beta\sqrt{2 J_2^\Trial}$, $z^\Trial \leftarrow \cfrac{I_1^\Trial}{\sqrt{3}}$
         \Comment{Compute Lode coordinates of the trial stress}
  \State $(r')^\Trial \leftarrow r^\Trial \sqrt{\cfrac{3K^\Told}{2G^\Told}}$
         \Comment{Transform the trial $r$ coordinate}
  \State $I_1^0 \leftarrow \zeta^\Told + \Half(X^\Told + I_1^\Tpeak)$, 
         $J_2^0 \leftarrow 0$  
         \Comment{Compute interior point}
  \State $r^0 \leftarrow \beta\sqrt{2 J_2^0}$, $z^0 \leftarrow \cfrac{I_1^0}{\sqrt{3}}$
         \Comment{Compute Lode coordinates of the interior point}
  \State $(r')^0 \leftarrow r^0 \sqrt{\cfrac{3K^\Told}{2G^\Told}}$
         \Comment{Transform the interior point $r$ coordinate} 
  \State $\theta \leftarrow 0$
  \Repeat
  \State $z^\Tnew, (r')^\Tnew \leftarrow$ \textsc{applyBisectionAlgorithm}($z^0$, $(r')^0$, $z^\Trial$, 
                                                                         $(r')^\Trial$, $X^\Told$, 
                                                                         $\zeta^\Told$, $K^\Told$, $G^\Told$,
                                                                         $\beta$)
         \Comment{Find intersection point on the non-hardening yield surface}
  \State $\theta$, $z^\Trot$, $(r')^\Trot \leftarrow$ \textsc{findNewInternalPoint}($z^\Trial$,$(r')^\Trial$,
             $z^\Tnew$, $(r')^\Tnew$, $\theta$, $X^\Told$, $\zeta^\Told$, $K^\Told$, $G^\Told$, $\beta$)
     \Comment{Apply rotation algorithm to find new internal point}
  \State $(r')^0 \leftarrow (r')^\Trot$, $z^0 \leftarrow z^\Trot$ 
  \Until {$\theta \le$ TOLERANCE}
  \State $I_1^\Tnew = \sqrt{3}\,z^\Tnew$, 
         $\sqrt{J_2^\Tnew} = \cfrac{2G^\Told}{3K^\Told}\,\cfrac{(r')^\Tnew}{\sqrt{2}\,\beta}$ 
         \Comment{Compute updated stress invariants}
  \State $\Bs^\Trial \leftarrow \Bsig^\Trial - \Third I_1^\Trial \BI$
         \Comment{Compute deviatoric trial stress}
  \State $\Bsig^\Tnew = \Third\,I_1^\Tnew\,\BI +
                       \cfrac{\sqrt{J_2^\Tnew}}{\sqrt{J_2^\Trial}}\,\Bs^\Trial$ 
         \Comment{Compute updated stress}
  \State $\delta\Bveps^{\Tp,\Tnew} = \delta\Bveps - \SfC^{-1}:(\Bsig^\Tnew - \Bsig^\Told)$
         \Comment{Compute plastic strain increment}
  \State \Return Outputs:
    \begin{itemize}
      \item $\Bsig^\Tnew$ \Comment{Updated stress tensor}
      \item $\delta\Bveps^{\Tp,\Tnew}$ \Comment{Increment in plastic strain}
    \end{itemize}
  \EndProcedure
\end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
\caption{Apply bisection algorithm to find point on yield surface.}
\begin{algorithmic}[1]
  \Procedure{applyBisectionAlgorithm}{$z^0$, $(r')^0$, $z^\Trial$, $(r')^\Trial$, $X^\Told$, $\zeta^\Told$, 
                                      $K^\Told$, $G^\Told$, $\beta$}
    \State $\eta^\Tin \leftarrow 0$, $\eta^\Tout \leftarrow 1$
    \While {$\eta^\Tout - \eta^\Tin \ge$ TOL}
      \State $\eta^\Tmid = \Half (\eta^\Tin + \eta^\Tout)$
      \State $\begin{bmatrix} z^\Tmid \\ (r')^\Tmid \end{bmatrix}
         \leftarrow \eta^\Tmid \begin{bmatrix} z^\Trial - z^0\\ (r')^\Trial - (r')^0 \end{bmatrix} + 
         \begin{bmatrix} z^0 \\ (r')^0 \end{bmatrix}$
      \State isElastic $\leftarrow$ \textsc{evalYieldCondition}($z^\Tmid$, $(r')^\Tmid$, $X^\Told$, 
                                                                $\zeta^\Told$, $K^\Told$, $G^\Told$,
                                                                $\beta$)
      \If {isElastic = TRUE}
         \State $\eta^\Tin \leftarrow \eta^\Tmid$
      \Else
         \State $\eta^\Tout \leftarrow \eta^\Tmid$
      \EndIf
    \EndWhile
    \State $z^\Tnew \leftarrow z^\Tmid$, $(r')^\Tnew \leftarrow (r')^\Tmid$ 
    \State \Return $z^\Tnew$, $(r')^\Tnew$
  \EndProcedure
\end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
\caption{Rotation around trial state to find internal point inside yield surface}
\begin{algorithmic}[1]
  \Procedure {findNewInternalPoint}{$z^\Trial$, $(r')^\Trial$, $z^\Tnew$, $(r')^\Tnew$, $\theta$,
                                    $X^\Told$, $\zeta^\Told$, $K^\Told$, $G^\Told$, $\beta$}
    \State $n \leftarrow 0$
    \Repeat
      \State $n \leftarrow n+1$
      \State $\theta \leftarrow (-1)^n \times \cfrac{\pi}{2} \times \left(\Half\right)^{\frac{\text{floor}(n)}{2}}$
      \State $\MQ \leftarrow 
              \begin{bmatrix} \cos\theta & -\sin\theta \\ \sin\theta & \cos\theta \end{bmatrix}$
      \State $\begin{bmatrix} z^\Trot \\ (r')^\Trot \end{bmatrix} \leftarrow
              \MQ \cdot \begin{bmatrix} z^\Tnew - z^\Trial \\ (r')^\Tnew - (r')^\Trial \end{bmatrix} +
              \begin{bmatrix} z^\Trial \\ (r')^\Trial \end{bmatrix}$
      \State isElastic $\leftarrow$ \textsc{evalYieldCondition}($z^\Trot, (r')^\Trot$,
                                                                $X^\Told$, $\zeta^\Told$, 
                                                                $K^\Told$, $G^\Told$, $\beta$)
    \Until {isElastic = FALSE}
    \State \Return $\theta$, $z^\Trot$, $(r')^\Trot$
  \EndProcedure
\end{algorithmic}
\end{breakablealgorithm}

\begin{breakablealgorithm}
\caption{Evaluate the yield condition}
\begin{algorithmic}[1]
  \Procedure{evalYieldCondition}{$z^\Tnew$, $(r')^\Tnew$, $X^\Told$, $\zeta^\Told$, $K^\Told$, $G^\Told$,
                                 $\beta$}
     \State $I_1^\Tnew \leftarrow \sqrt{3}\,z^\Tnew$, 
            $\sqrt{J_2^\Tnew} \leftarrow \cfrac{2G^\Told}{3K^\Told}\times
              \cfrac{1}{\sqrt{2}\,\beta}\times(r')^\Tnew$
            \Comment{Transform back into stress space}
     \State isElastic $\leftarrow$ \textsc{evalYieldCondition}($I_1^\Tnew$, $\sqrt{J_2^\Tnew}$, 
                                                             $X^\Told$, $\zeta^\Told$, 
                                                             $K^\Told$, $G^\Told$, $\beta$)
     \State \Return isElastic
  \EndProcedure
\end{algorithmic}
\end{breakablealgorithm}
